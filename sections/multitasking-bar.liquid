{%- if section.blocks.size > 0 -%}
    {% style %}
        .multitasking-bar {
            top: 50%;
            width: auto;
            padding: 0.2rem;
            border-radius: 3rem;
            box-shadow: 0.2rem 0.4rem 0.9rem 0 rgba(176, 173, 173, 0.35);
            background: rgb(var(--color-background));
            opacity: 0;
            visibility: hidden;
            transform: translate3d(2rem,-50%,0);
            transition: opacity var(--duration-long) ease, visibility var(--duration-long) ease, transform var(--duration-long) ease;
            will-change: transform;
        }

        .multi-t__button {
            width: 4rem;
            height: 4rem;
            background: transparent;
            transition: all var(--duration-default) ease;
        }

        .multi-t__button:after {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            right: 0;
            width: 4rem;
            height: 4rem;
            pointer-events: none;
        }

        .multi-t__button .icon {
            color: rgba(var(--color-foreground), 1);
            display: block;
            width: 1.8rem;
            height: 1.8rem;
            z-index: 1;
            transition-property: color, transform;
            transition-duration: var(--duration-long);
            transition-timing-function: ease;
            will-change: transform;
        }

        .multi-t__button .icon-arrow {
            transform: rotate(-90deg);
        }

        .multi-t__button:hover .icon{
            transform: scale(1.09);
        }

        .multi-t__button:hover .icon-arrow{
            transform: rotate(-90deg) scale(1.09);
        }

        .recently-viewed__warnings .icon{
            display: block;
            width: 4.6rem;
            height: 4.6rem;
            z-index: 1;
            color: rgba(var(--color-foreground), 0.1);
            margin: 0 auto 1rem auto;
        }

        .recently-viewed-products .product-item {
            padding-bottom: 1rem;
        }

        .multi-t__list .list-social__item {
            padding: 0.2rem;
            border-radius: 50%;
        }

        .multi-t__list .list-social__link {
            padding: 0.9rem;
        }

        .target-block.active .multi-t__button .icon,
        .button__back-to-top[data-index="1"].active.hide + .target-block .multi-t__button .icon {
            color: rgba(var(--secondary-icon), 1);
        }

        .multi-t__wrap [data-index="1"].active ~ .glider {
            transform: translateY(0);
        }

        .multi-t__wrap [data-index="2"].active ~ .glider {
            transform: translateY(100%);
        }

        .multi-t__wrap [data-index="3"].active ~ .glider {
            transform: translateY(200%);
        }

        .multi-t__wrap .button__back-to-top.hide ~ [data-index="2"].active ~ .glider {
            transform: translateY(0);
        }

        .multi-t__wrap .button__back-to-top.hide ~ [data-index="3"].active ~ .glider {
            transform: translateY(100%);
        }

        .multi-t__social {
            right: calc(100% + 0.5rem);
            padding-inline: 0.5rem;
            border-radius: 3rem;
            box-shadow: 0.2rem 0.4rem 0.9rem 0 rgba(176, 173, 173, 0.35);
            opacity: 0;
            visibility: hidden;
            transform: translate(2rem);
            transition: opacity var(--duration-long) ease, visibility var(--duration-long) ease, transform var(--duration-long) ease;
            will-change: transform;
        }

        .multi-t__social.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
            pointer-events: auto;
        }

        .multi-t__social .list-social {
            flex-wrap: nowrap;
        }

        .glider {
            height: 4rem;
            width: 4rem;
            z-index: -1;
            background-color: rgba(var(--secondary-icon-background), 1);
            transition: 0.25s ease-out;
        }

        .button__back-to-top {
            height: var(--hei-cus, 0);
            transition: opacity var(--duration-medium) ease, height var(--duration-medium) var(--cubic-smooth);
        }

        .button__back-to-top.hide {
            opacity: 0;
        }

        body.overflow-hidden .multitasking-bar {
            right: calc(var(--right-a) + var(--scrollbar-width, 0rem));
        }

        body:not(.has--preload-screen) .multitasking-bar {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translate3d(0, -50%, 0);
        }

        @media only screen and (min-width: 750px) {
            .multitasking-bar {
                padding: 0.5rem 0.4rem;
            }

            .multi-t__button,
            .multi-t__button:after,
            .glider {
                width: 4.4rem;
                height: 4.4rem;
            }
        }

        @media only screen and (min-width: 1025px) {
            body.overflow-hidden .multitasking-bar {
                right: calc(var(--right-a) + var(--scrollbar-width, 0rem) - 0.1rem);
            }
        }
    {% endstyle %}

    <multitasking-bar
        class="multitasking-bar pos-fixed hei-auto z-index-2 gradient no-js-hidden"
        id="multitasking-bar"
        style="
            --right-a: 0.5%;
            --color-background: {{ section.settings.background.red }},{{ section.settings.background.green }},{{ section.settings.background.blue }};
            --color-foreground: {{ section.settings.icon.red }},{{ section.settings.icon.green }},{{ section.settings.icon.blue }};
            --secondary-icon-background: {{ section.settings.secondary_background.red }},{{ section.settings.secondary_background.green }},{{ section.settings.secondary_background.blue }};
            --secondary-icon: {{ section.settings.secondary_icon.red }},{{ section.settings.secondary_icon.green }},{{ section.settings.secondary_icon.blue }};
        "
    >
        <div class="multi-t__wrap pos-relative dis-flex f-column" id="multitasking-wrap">
            {%- for block in section.blocks -%}
                {%- case block.type -%}
                    {%- when 'recently_viewed_products' -%}
                        <side-drawer-opener
                            class="target-block product-popup-modal__opener dis-i-block{% if forloop.first %} active{% endif %}"
                            data-side-drawer="#popup-recently-viewed"
                            data-index="{{ forloop.index }}"
                        >
                            <button
                                class="multi-t__button pad-0 dis-flex a-i-center j-c-center pos-relative c-pointer bor-none bor-circle gradient"
                                data-target="multitasking-recently-viewed"
                                type="button"
                                aria-haspopup="dialog"
                                aria-label="{{ 'sections.multitasking_bar.recently_viewed_products' | t }}"
                                {{ block.shopify_attributes }}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.1 479.39" class="icon icon-recently-viewed" aria-hidden="true" focusable="false" role="presentation">
                                    <path fill="currentColor" d="M250.58,479.39c-8.32-1.31-16.7-2.36-25-4-58.29-11.37-105.26-40.94-141.09-88.24-6.86-9-6-18.73,1.94-24.57,7.7-5.66,17.09-3.57,23.74,5.32A197.18,197.18,0,0,0,285.56,446.7c72.16-6.1,127.32-40.21,164.81-101.93,22.25-36.62,30.95-76.91,28.1-119.78C473.08,143.56,418.19,68.58,336,42.73,264,20.1,197.59,33,138.89,80.58c-39.2,31.76-62.43,73.51-71.65,123.08a18.25,18.25,0,0,0,0,2.25c3.3-3.35,6-6.23,8.87-9,7-6.73,16.75-6.83,23.16-.32s6.29,16-.37,22.79q-19.62,19.91-39.52,39.51c-7.84,7.69-18.7,6.59-24.91-2.55Q18.49,232.88,3,209.09c-5.28-8.05-3.26-17.8,4.37-22.77,7.4-4.82,16.78-2.75,22.34,5,1.69,2.35,3.28,4.77,4.95,7.2,3.88-13.53,6.68-26.87,11.5-39.44C77.69,76.7,136.3,23.79,222.64,5.76,310-12.48,385.78,12.89,447.42,77.41c35.21,36.85,55.29,81.56,61.78,132.24.56,4.41,1.26,8.8,1.9,13.21v33.93c-.4,2.94-.85,5.87-1.2,8.81-5.35,45.62-21.73,86.8-50.45,122.74q-56,70.11-144.41,87.05c-8.78,1.66-17.68,2.68-26.53,4Z"/>
                                    <path fill="currentColor" d="M247.61,175.92q0-35.19,0-70.37c0-10.53,6.54-17.52,16.19-17.43,9.28.1,15.7,7.19,15.7,17.45q0,64.62-.07,129.25a8.58,8.58,0,0,0,3.86,7.83c27.65,20.75,55.29,41.54,82.66,62.66A24.82,24.82,0,0,1,374,316.64c2.14,6.68-1.19,13.35-6.94,16.69-6.18,3.6-12.43,3.38-18.23-.89-10.44-7.69-20.78-15.53-31.15-23.31-20.74-15.56-41.43-31.21-62.26-46.66a18.08,18.08,0,0,1-7.9-15.69C247.68,223.16,247.61,199.54,247.61,175.92Z"/>
                                </svg>
                            </button>
                        </side-drawer-opener>

                        <side-drawer
                            class="multi-t__products drawer pos-fixed top-0 left-0 wid-100v hei-100 z-index-9 dis-flex j-c-end no-js-hidden"
                            id="popup-recently-viewed"
                        >
                            {{ 'quick-add.css' | asset_url | stylesheet_tag }}

                            <div id="Drawer-Overlay-Multitasking-Bar" class="drawer__overlay pos-fixed inset-0 c-pointer"></div>
                            <div
                                class="drawer__inner gradient cus-scrollbar"
                                role="dialog"
                                aria-modal="true"
                                aria-label="{{ 'sections.recently_viewed.title' | t }}"
                                tabindex="-1"
                            >
                                <div class="drawer__header dis-flex j-c-between a-i-center pos-relative" style="--pad-a-a: 1.5rem 0;">
                                    <h2 class="drawer__heading break mar-0">{{ 'sections.recently_viewed.title' | t }}</h2>
                                    <button class="drawer__close dis-block t-button bor-none bor-circle c-pointer" type="button" onclick="this.closest('side-drawer').close()" aria-label="{{ 'accessibility.close' | t }}">
                                        {{- 'icon-close.svg' | inline_asset_content -}}
                                    </button>
                                </div>
                                <recently-viewed-products
                                    class="recently-viewed-products collection"
                                    id="recently-viewed-drawer-{{ section.id }}"
                                    data-url="{{ routes.search_url }}?section_id={{ section.id }}&type=product&q="
                                    data-limit="{{ block.settings.products_to_show }}"
                                    data-id="{{ section.id }}"
                                    {% if request.page_type == 'product' %}
                                        data-product-id="{{ product.id }}"
                                    {% endif %}
                                >
                                    {%- if request.page_type == 'search' and search.results_count > 0 and search.performed -%}
                                        <ul class="list-unstyled" role="list">
                                            {% assign parsed_terms = search.terms | split: ' OR ' %}
                                            {% assign skip_card_product_styles = false %}
                                            {%- for parsed_term in parsed_terms -%}
                                                {%- assign product_id = parsed_term | split: 'id:' | last | times: 1 -%}
                                                {%- for product in search.results -%}
                                                    {%- if product.id == product_id -%}
                                                        <li class="product-item">
                                                            {% render 'card-product',
                                                            card_product: product,
                                                            media_aspect_ratio: 'square',
                                                            show_secondary_image: false,
                                                            lazy_load: false,
                                                            show_vendor: section.settings.show_vendor,
                                                            show_rating: section.settings.show_rating,
                                                            skip_styles: skip_card_product_styles,
                                                            section_id: section.id,
                                                            quick_add: 'standard',
                                                            horizontal_class: true,
                                                            horizontal_quick_add: true
                                                            %}
                                                        </li>
                                                        {%- assign skip_card_product_styles = true -%}
                                                    {%- endif -%}
                                                {%- endfor -%}
                                            {%- endfor -%}
                                        </ul>
                                    {%- else -%}
                                        <div class="recently-viewed__warnings dis-flex f-column f-1 j-c-center center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 455 455" xmlns:xlink="http://www.w3.org/1999/xlink" class="icon icon-no-product" aria-hidden="true" focusable="false" role="presentation" xml:space="preserve">
                                                <path d="M360.967,130.599c-4.06-0.818-8.018,1.8-8.841,5.86c-0.823,4.06,1.801,8.018,5.86,8.841
                                                c1.147,0.232,2.013,1.286,2.013,2.45v160c0,1.355-1.145,2.5-2.5,2.5H179.676c-4.142,0-7.5,3.357-7.5,7.5s3.358,7.5,7.5,7.5H357.5
                                                c9.649,0,17.5-7.851,17.5-17.5v-160C375,139.46,369.099,132.247,360.967,130.599z"></path>
                                                <path d="M274.824,130.25H97.5c-9.649,0-17.5,7.851-17.5,17.5v160c0,8.063,5.48,15.046,13.326,16.982
                                                c0.604,0.149,1.208,0.221,1.803,0.221c3.369,0,6.432-2.287,7.276-5.705c0.992-4.021-1.463-8.086-5.484-9.078
                                                c-0.955-0.235-1.92-1.143-1.92-2.42v-160c0-1.355,1.145-2.5,2.5-2.5h177.324c4.142,0,7.5-3.357,7.5-7.5
                                                S278.966,130.25,274.824,130.25z"></path>
                                                <path d="M235.363,170.798c-2.655-0.363-5.3-0.548-7.863-0.548c-31.706,0-57.5,25.794-57.5,57.5c0,2.563,0.185,5.209,0.548,7.863
                                                c0.515,3.759,3.731,6.483,7.421,6.483c0.339,0,0.682-0.023,1.027-0.07c4.104-0.562,6.975-4.345,6.413-8.448
                                                c-0.271-1.982-0.409-3.943-0.409-5.828c0-23.435,19.065-42.5,42.5-42.5c1.884,0,3.845,0.138,5.828,0.409
                                                c4.108,0.564,7.886-2.309,8.448-6.413C242.338,175.143,239.467,171.359,235.363,170.798z"></path>
                                                <path d="M219.127,284.636c2.789,0.407,5.605,0.614,8.373,0.614c31.706,0,57.5-25.794,57.5-57.5c0-2.77-0.207-5.587-0.613-8.373
                                                c-0.599-4.099-4.408-6.934-8.505-6.337c-4.099,0.599-6.936,4.406-6.337,8.505c0.303,2.071,0.456,4.158,0.456,6.205
                                                c0,23.435-19.065,42.5-42.5,42.5c-2.044,0-4.132-0.153-6.205-0.456c-4.099-0.6-7.907,2.238-8.505,6.337
                                                S215.028,284.037,219.127,284.636z"></path>
                                                <path d="M318.5,203.25c9.098,0,16.5-7.402,16.5-16.5c0-8.318-6.227-15.355-14.484-16.37c-2.293-0.277-4.585,0.509-6.218,2.142
                                                l-10.027,10.027c-1.633,1.632-2.422,3.926-2.141,6.217C303.145,197.023,310.183,203.25,318.5,203.25z"></path>
                                                <path d="M117.5,114.75h30c4.142,0,7.5-3.357,7.5-7.5s-3.358-7.5-7.5-7.5h-30c-4.142,0-7.5,3.357-7.5,7.5
                                                S113.358,114.75,117.5,114.75z"></path>
                                                <path d="M388.367,66.633C345.397,23.664,288.268,0,227.5,0S109.603,23.664,66.633,66.633C23.664,109.603,0,166.732,0,227.5
                                                s23.664,117.897,66.633,160.867C109.603,431.336,166.732,455,227.5,455s117.897-23.664,160.867-66.633
                                                C431.336,345.397,455,288.268,455,227.5S431.336,109.603,388.367,66.633z M15,227.5C15,110.327,110.327,15,227.5,15
                                                c55.894,0,106.807,21.703,144.783,57.11L72.11,372.283C36.703,334.307,15,283.395,15,227.5z M227.5,440
                                                c-55.894,0-106.807-21.703-144.783-57.11L382.89,82.717C418.297,120.693,440,171.606,440,227.5C440,344.673,344.673,440,227.5,440z
                                                "></path>
                                            </svg>
                                            <span class="text">{{ 'sections.recently_viewed.empty' | t }}</span>
                                        </div>
                                    {%- endif -%}
                                </recently-viewed-products>
                            </div>
                            {%- liquid
                                assign files = 'product-form.js, quick-add.js' | split: ', '
                                render 'theme-loader', files: files
                            -%}
                        </side-drawer>
                    {%- when 'social_media' -%}
                        <div class="target-block pos-relative{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index }}">
                            <button
                                class="multi-t__button pad-0 dis-flex a-i-center j-c-center pos-relative c-pointer bor-none bor-circle gradient"
                                data-target="multitasking-social-media"
                                type="button"
                                aria-haspopup="dialog"
                                aria-label="{{ 'sections.multitasking_bar.social_media' | t }}"
                                {{ block.shopify_attributes }}
                            >
                                <span class="svg-wrapper">
                                    {{ 'icon-share.svg' | inline_asset_content }}
                                </span>
                            </button>

                            <div class="multi-t__wrapper multi-t__social pointer-e-none pos-absolute top-0 gradient">
                                {%- render 'social-icons', class: 'multi-t__list' -%}
                            </div>
                        </div>
                    {%- when 'back_to_top' -%}
                        <div class="target-block pos-relative button__back-to-top{% if forloop.first %} active{% endif %} hide" data-index="{{ forloop.index }}">
                            <button
                                class="multi-t__button pad-0 dis-flex a-i-center j-c-center pos-relative c-pointer bor-none bor-circle gradient"
                                data-target="back-to-top"
                                role="button"
                                aria-haspopup="dialog"
                                aria-label="{{ 'sections.multitasking_bar.back_to_top' | t }}"
                                {{ block.shopify_attributes }}
                            >
                                <span class="svg-wrapper">
                                    {{- 'icon-arrow.svg' | inline_asset_content -}}
                                </span>
                            </button>
                        </div>
                {%- endcase -%}
            {%- endfor -%}
            <span class="glider pos-absolute dis-flex bor-circle"></span>
        </div>
    </multitasking-bar>

    <script defer="defer">
        class MultitaskingBar extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                this.init();
            }

            disconnectedCallback() {
                window.removeEventListener('scroll', this.handleScroll);
            }

            init() {
                this.buttonToggle = this.querySelectorAll('.multi-t__button');
                this.onBodyClick = this.handleBodyClick.bind(this);

                if (this.querySelector('.button__back-to-top')) {
                    this.scrollTopHeight = this.querySelector('.button__back-to-top .multi-t__button').offsetHeight;
                    this.handleScroll = this.throttleScroll.bind(this);
                    window.addEventListener('scroll', this.handleScroll);
                }

                this.buttonToggle?.forEach((button) => {
                    button.addEventListener('click', this.open.bind(this));
                });

                ['.drawer__close', '[id^="Drawer-Overlay-"]'].forEach(selector => {
                    this.querySelector(selector)?.addEventListener('click', this.close.bind(this));
                });
            }

            open(event){
                this.buttonToggle?.forEach((button) => {
                    if(button != event.currentTarget) {
                        button.closest('.target-block')?.classList.remove('active');
                        button.closest('.target-block').querySelector('.multi-t__wrapper')?.classList.remove('active');
                    } else {
                        this.activeFirst = this.querySelector(`.target-block:first-child`);
                        if (button.closest('.target-block').classList.contains('active') && !this.activeFirst.classList.contains('active')) {
                            this.activeFirst.classList.add('active');
                        } else {
                            this.activeFirst.classList.remove('active');
                        };
                    }
                });

                const targetBlock = event.currentTarget.closest('.target-block');
                const _target = event.currentTarget.dataset.target;
                if (targetBlock) {
                    targetBlock.classList.toggle('active');

                    if (_target === 'multitasking-social-media') {
                        targetBlock.querySelector('.multi-t__wrapper')?.classList.toggle('active');
                    } else if (_target === 'back-to-top') {
                        window.scroll({ top: 0, behavior: 'smooth' });
                        return false;
                    }
                }

                document.body.addEventListener('click', this.onBodyClick);
            }

            close() {
                this.querySelectorAll('.target-block.active').forEach(button => {
                    button.classList.remove('active');
                    button.querySelector('.multi-t__wrapper')?.classList.remove('active');
                    this.querySelector('.target-block:first-child').classList.add('active');
                });

                document.body.removeEventListener('click', this.onBodyClick);
            }

            handleBodyClick(event) {
                const target = event.target;
                if (!this.contains(target) && target !== document.getElementsByClassName('popup__inner') && !target.closest('.popup__inner')) this.close();
            }

            throttleScroll() {
                if (!this.isScrolling) {
                    window.requestAnimationFrame(() => {
                        this.onScroll();
                        this.isScrolling = false;
                    });
                }
                this.isScrolling = true;
            }

            onScroll() {
                const backToTopButton = this.querySelector('.button__back-to-top');
                const firstTargetBlock = this.querySelector('.target-block:first-child');

                if (window.pageYOffset <= 300) {
                    backToTopButton.classList.add('hide');

                    if (!this.querySelector(`.button__back-to-top:first-child`)) {
                        backToTopButton.classList.remove('active');
                        firstTargetBlock?.classList.add('active');
                    }

                    backToTopButton.style.setProperty('--hei-cus', '0px');
                } else {
                    backToTopButton.classList.remove('hide');
                    backToTopButton.style.setProperty('--hei-cus', `${this.scrollTopHeight}px`);
                }
            }
        }

        customElements.define('multitasking-bar', MultitaskingBar);
    </script>
{%- endif -%}

{% schema %}
{
    "name": "t:sections.multitasking-bar.name",
    "tag": "section",
    "class": "section-multitasking-bar",
    "limit": 1,
    "enabled_on": {
        "groups": ["custom.popup"]
    },
    "settings": [
        {
            "type": "header",
            "content": "t:sections.all.colors.name"
        },
        {
            "type": "color",
            "id": "background",
            "default": "#ffffff",
            "label": "t:sections.multitasking-bar.settings.colors.settings.icon_background.label"
        },
        {
            "type": "color",
            "id": "icon",
            "default": "#000000",
            "label": "t:sections.multitasking-bar.settings.colors.settings.icon.label"
        },
        {
            "type": "color",
            "id": "secondary_background",
            "default": "#1199BB",
            "label": "t:sections.multitasking-bar.settings.colors.settings.secondary_icon_background.label"
        },
        {
            "type": "color",
            "id": "secondary_icon",
            "default": "#FFFFFF",
            "label": "t:sections.multitasking-bar.settings.colors.settings.secondary_icon.label"
        }
    ],
    "blocks": [
        {
            "type": "recently_viewed_products",
            "name": "t:sections.multitasking-bar.blocks.recently-viewed-products.name",
            "limit": 1,
            "settings": [
                {
                    "type": "paragraph",
                    "content": "t:sections.multitasking-bar.blocks.recently-viewed-products.info"
                },
                {
                    "type": "range",
                    "id": "products_to_show",
                    "min": 2,
                    "max": 10,
                    "step": 1,
                    "default": 4,
                    "label": "t:sections.recently-viewed-products.settings.products_to_show.label"
                },
                {
                    "type": "checkbox",
                    "id": "show_vendor",
                    "default": false,
                    "label": "t:sections.recently-viewed-products.settings.show_vendor.label"
                },
                {
                    "type": "checkbox",
                    "id": "show_rating",
                    "default": false,
                    "label": "t:sections.recently-viewed-products.settings.show_rating.label",
                    "info": "t:sections.recently-viewed-products.settings.show_rating.info"
                }
            ]
        },
        {
            "type": "social_media",
            "name": "t:sections.multitasking-bar.blocks.social-media.name",
            "limit": 1,
            "settings": [
                {
                    "type": "paragraph",
                    "content": "t:sections.multitasking-bar.blocks.social-media.info"
                }
            ]
        },
        {
            "type": "back_to_top",
            "name": "t:sections.multitasking-bar.blocks.back-to-top.name",
            "limit": 1
        }
    ],
    "presets": [
        {
            "name": "t:sections.multitasking-bar.name"
        }
    ]
}
{% endschema %}