{% comment %}
    "groups": ["custom.popup"]
{% endcomment %}

<style>
    .promotion-popup__close.close-effect .line {
        background: var(--color-foreground);
    }

    .promotion-popup__info .promotion--button {
        padding-top: 1.6rem;
        padding-bottom: 1.4rem;
        font-size: 1.6rem;
        min-height: calc(5.2rem + var(--buttons-border-width) * 2)
    }

    .promotion-popup__info .button--submit {
        max-width: calc(100% - var(--buttons-border-width) * 2);
    }

    .promotion-popup__info .promotion--button svg {
        width: 1.8rem;
        height: 1.8rem;
    }

    .promotion--button.button--primary + .promotion--social {
        margin-top: 2rem;
    }

    .promotion-popup__info .field__input::-webkit-input-placeholder{
        text-transform: var(--heading-text-transform);
    }

    .promotion-popup__info .field__input::-moz-placeholder{
        text-transform: var(--heading-text-transform);
    }

    .promotion-popup__info .field__input::-ms-input-placeholder{
        text-transform: var(--heading-text-transform);
    }

    @media screen and (min-width: 1025px) {
        .promotion-popup__info .button--tertiary {
            font-size: 2rem;
        }
    }
</style>

{%- liquid
    assign blocks_size = section.blocks.size
    if section.settings.image != blank and blocks_size > 0
        assign width_content = 935
        assign width_info = 'calc(100% - 395px)'
        assign width_info_md = 55
    elsif blocks_size == 0
        assign width_content = 395
        assign width_info = '100%'
        assign width_info_md = 100
    else
        assign width_content = 540
        assign width_info = '100%'
        assign width_info_md = 100
    endif
-%}

<side-drawer class="drawer pos-fixed top-0 left-0 z-index-9 wid-100v hei-100 dis-flex j-c-center no-js-hidden" element-s-popup id="Promotion-popup-{{ section.id }}" data-moved="false" tabindex="-1">
    <div id="Drawer-Overlay-Promotion-{{ section.id }}" class="drawer__overlay pos-fixed inset-0 c-pointer"></div>
    <promotion-popup class="popup__inner promotion-popup wid-100 hei-auto pos-absolute-c-c dis-flex f-column global-settings-popup gradient color-{{ section.settings.color_scheme }}"
        role="dialog"
        aria-modal="true"
        aria-label="{{ 'accessibility.promotion-popup' | t }}"
        style="--popup-max-width: {{ width_content }}px; --popup-max-height: min(100%, 75vh); --pad-a-a: 0;"
        data-expire="{{ section.settings.popup_expire }}"
        data-delay="{{ section.settings.popup_delay | times: 1000 }}"
    >
        <div class="dis-flex pos-relative wid-100 hei-100 over-a cus-scrollbar" style="--pad-a-a: 0 1rem 0 0;">
            {%- if section.settings.image != blank -%}
                <div class="promotion-popup__image small-hide" style="--wid-a: 45%; --wid-a-lg: 395px;">
                    <div class="media pos-relative hei-100" style="padding-bottom: {{ 1 | divided_by: section.settings.image.aspect_ratio | times: 100 }}%;">
                        <img
                            srcset="
                                {%- if section.settings.image.width >= 165 -%}{{ section.settings.image | image_url: width: 165 }} 165w,{%- endif -%}
                                {%- if section.settings.image.width >= 330 -%}{{ section.settings.image | image_url: width: 330 }} 330w,{%- endif -%}
                                {%- if section.settings.image.width >= 535 -%}{{ section.settings.image | image_url: width: 535 }} 535w,{%- endif -%}
                                {%- if section.settings.image.width >= 750 -%}{{ section.settings.image | image_url: width: 750 }} 750w,{%- endif -%}
                                {%- if section.settings.image.width >= 1000 -%}{{ section.settings.image | image_url: width: 1000 }} 1000w,{%- endif -%}
                                {%- if section.settings.image.width >= 1500 -%}{{ section.settings.image | image_url: width: 1500 }} 1500w,{%- endif -%}
                                {%- if section.settings.image.width >= 3000 -%}{{ section.settings.image | image_url: width: 3000 }} 3000w,{%- endif -%}
                                {{ section.settings.image | image_url }} {{ section.settings.image.width }}w
                            "
                            src="{{ section.settings.image | image_url: width: 1500 }}"
                            sizes="
                                (min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 100 | divided_by: 2 }}px,
                                (min-width: 750px) calc((100vw - 10rem) / 2),
                                calc(100vw - 3rem)
                            "
                            alt="{{ section.settings.image.alt | escape }}"
                            height="{{ section.settings.image.height }}"
                            width="{{ section.settings.image.width }}"
                            loading="lazy"
                            fetchpriority="low"
                            class="motion-reduce"
                        >
                    </div>
                </div>
            {%- endif -%}
            {%- if blocks_size > 0 -%}
                <div class="promotion-popup__info dis-flex f-column a-i-center hei-100 over-y-a over-x-h scroll-b-sm" style="--pad-a-a: 2.6rem 2rem; --pad-a-a-md: 5rem 3rem; --pad-a-a-lg: 5rem 3rem; --wid-a: 100%; --wid-a-md: {{ width_info_md }}%; --wid-a-lg: {{ width_info }};">
                    {%- for block in section.blocks -%}
                        {%- case block.type -%}
                            {%- when 'heading' -%}
                                {%- if block.settings.heading != blank -%}
                                    <h2 class="inline-richtext {{ block.settings.heading_size }}" style="--blo-m-t-a: 1rem;" {{ block.shopify_attributes }}>
                                        {{ block.settings.heading | escape }}
                                    </h2>
                                {%- endif -%}
                            {%- when 'paragraph' -%}
                                {%- if block.settings.text != blank -%}
                                    <div class="newsletter__subheading rte" style="--blo-m-t-a: 2rem;" {{ block.shopify_attributes }}>
                                        {{ block.settings.text }}
                                    </div>
                                {%- endif -%}
                            {%- when 'email_form' -%}
                                <div class="wid-100" {{ block.shopify_attributes }}>
                                    {% form 'customer', class: 'newsletter-form', id: 'ContactFormPopup' %}
                                        <input type="hidden" name="contact[tags]" value="newsletter">
                                        <div
                                            class="newsletter-form__field-wrapper{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                                            {% if settings.animations_reveal_on_scroll %}
                                                data-cascade
                                                style="--animation-order: {{ forloop.index }};"
                                            {% endif %}
                                        >
                                            <div class="field">
                                                <input
                                                    id="NewsletterForm--{{ section.id }}"
                                                    type="email"
                                                    name="contact[email]"
                                                    class="field__input"
                                                    value="{{ form.email }}"
                                                    aria-required="true"
                                                    autocorrect="off"
                                                    autocapitalize="off"
                                                    autocomplete="email"
                                                    {% if form.errors %}
                                                        autofocus
                                                        aria-invalid="true"
                                                        aria-describedby="Newsletter-error--{{ section.id }}"
                                                    {% elsif form.posted_successfully? %}
                                                        aria-describedby="Newsletter-success--{{ section.id }}"
                                                    {% endif %}
                                                    placeholder="{{ 'newsletter.label' | t }}"
                                                    required
                                                >
                                                <label class="field__label" for="NewsletterForm--{{ section.id }}">
                                                    {{ 'newsletter.label' | t }}
                                                </label>
                                                <button
                                                    type="submit"
                                                    class="newsletter-form__button field__button"
                                                    name="commit"
                                                    id="Subscribe"
                                                    aria-label="{{ 'newsletter.button_label' | t }}"
                                                >
                                                    <span class="svg-wrapper">
                                                        {{- 'icon-arrow.svg' | inline_asset_content -}}
                                                    </span>
                                                </button>
                                            </div>
                                            {%- if form.errors -%}
                                                <small class="newsletter-form__message form__message" id="Newsletter-error--{{ section.id }}">
                                                    <span class="svg-wrapper">
                                                        {{- 'icon-error.svg' | inline_asset_content -}}
                                                    </span>
                                                    {{- form.errors.translated_fields.email | capitalize }}
                                                    {{ form.errors.messages.email -}}
                                                </small>
                                            {%- endif -%}
                                        </div>
                                        {%- if form.posted_successfully? -%}
                                            <h3
                                                class="newsletter-form__message newsletter-form__message--success form__message"
                                                id="Newsletter-success--{{ section.id }}"
                                                tabindex="-1"
                                                autofocus
                                            >
                                                <span class="svg-wrapper">
                                                    {{- 'icon-success.svg' | inline_asset_content -}}
                                                </span>
                                                {{- 'newsletter.success' | t }}
                                            </h3>
                                        {%- endif -%}
                                    {% endform %}
                                </div>
                            {%- when 'button' -%}
                                {%- if block.settings.button_label != blank -%}
                                    <a
                                        {% if block.settings.button_link == blank %}
                                            role="link" aria-disabled="true"
                                        {% else %}
                                            href="{{ block.settings.button_link }}"
                                        {% endif %}
                                        class="button wid-100{% if block.settings.button_style_secondary %} button-secondary{% else %} button--primary{% endif %}"
                                        {{ block.shopify_attributes }}
                                    >
                                        {{ block.settings.button_label | escape }}
                                    </a>
                                {%- endif -%}
                            {%- when 'social_media' -%}
                                <div class="dis-flex j-c-center promotion--social" style="--blo-m-t-a: 1.2rem;" {{ block.shopify_attributes }}>
                                    {%- render 'social-icons' -%}
                                </div>
                        {%- endcase -%}
                    {%- endfor -%}
                </div>
            {%- endif -%}
            <button class="drawer__close dis-block t-button bor-none bor-circle c-pointer pos-absolute" type="button" onclick="this.closest('side-drawer').close()" aria-label="{{ 'accessibility.close' | t }}" style="--top-a: 0.3rem; --right-a: 0.3rem;">
                {{- 'icon-close.svg' | inline_asset_content -}}
            </button>
        </div>
    </promotion-popup>
</side-drawer>

<script defer="defer">
    class PromotionPopup extends HTMLElement {
        constructor() {
            super();
            this.drawer = this.closest('.drawer');
            this.cookieName = '_halo_promotion_popup';
            this.expiresDate = this.getAttribute('data-expire');
            this.timeToShow = parseInt(this.getAttribute('data-delay'));

            this.load();
            this.querySelector('.drawer__close').addEventListener('click', this.setClose.bind(this));
            this.drawer.querySelector('[id^="Drawer-Overlay-"]').addEventListener('click', this.setClose.bind(this));

            if (Shopify.designMode) {
                document.addEventListener('shopify:section:select', (e) => {
                    if (e.target.matches('.section-promotion-popup')) this.setOpen(0);
                });

                document.addEventListener('shopify:section:deselect', (e) => {
                    if (e.target.matches('.section-promotion-popup')) this.setClose();
                });
            }
        }

        load() {
            if (this.querySelector('.form__message') && !this.getCookie(this.cookieName)) this.drawer.classList.add('active');
            if (!this.getCookie(this.cookieName) && !Shopify.designMode) this.setOpen(this.timeToShow);
        }

        setOpen(timeToShow) {
            if (!this.querySelector('.promotion-popup__image, .promotion-popup__info')) {
                this.setClose();
                return;
            }

            setTimeout(() => {
                this.drawer.classList.add('active');
                document.body.classList.add('overflow-hidden');

                this.drawer.addEventListener('transitionend', () => {
                    const containerToTrapFocusOn = this.drawer.querySelector('.popup__inner');
                    const focusElement = this.drawer.querySelector('.field__input');
                    trapFocus(containerToTrapFocusOn, focusElement);
                }, { once: true });
            }, timeToShow);
        }

        setClose() {
            this.setCookie(this.cookieName, 'closed', this.expiresDate);
            this.drawer.classList.remove('active');
            document.body.classList.remove('overflow-hidden');
            removeTrapFocus(this.activeElement);
        }

        setActiveElement(element) {
            this.activeElement = element;
        }

        setCookie(name, value, days) {
            var d = new Date;
            d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * days);
            document.cookie = name + "=" + value + ";path=/;expires=" + d.toGMTString();
        }

        getCookie(name) {
            var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }
    }

    customElements.define('promotion-popup', PromotionPopup);
</script>

{% schema %}
{
    "name": "t:sections.promotion-popup.name",
    "tag": "section",
    "class": "section-promotion-popup",
    "settings": [
        {
            "type": "color_scheme",
            "id": "color_scheme",
            "label": "t:sections.all.colors.label",
            "default": "scheme-1"
        },
        {
            "type": "range",
            "id": "popup_delay",
            "max": 60,
            "min": 1,
            "step": 1,
            "unit": "s",
            "label": "t:sections.promotion-popup.settings.delay_time.label",
            "default": 5
        },
        {
            "type": "range",
            "id": "popup_expire",
            "max": 30,
            "min": 1,
            "step": 1,
            "unit": "day",
            "label": "t:sections.promotion-popup.settings.show_again_after.label",
            "default": 1
        },
        {
            "type": "image_picker",
            "id": "image",
            "label": "t:sections.promotion-popup.settings.image.label",
            "info": "t:sections.promotion-popup.settings.image.info"
        }
    ],
    "blocks": [
        {
            "type": "heading",
            "name": "t:sections.promotion-popup.blocks.heading.name",
            "limit": 1,
            "settings": [
                {
                    "type": "inline_richtext",
                    "id": "heading",
                    "default": "t:sections.newsletter.blocks.heading.settings.heading.default",
                    "label": "t:sections.promotion-popup.blocks.heading.name"
                },
                {
                    "type": "select",
                    "id": "heading_size",
                    "options": [
                        {
                            "value": "h2",
                            "label": "t:sections.all.heading_size.options__1.label"
                        },
                        {
                            "value": "h1",
                            "label": "t:sections.all.heading_size.options__2.label"
                        },
                        {
                            "value": "h0",
                            "label": "t:sections.all.heading_size.options__3.label"
                        },
                        {
                            "value": "hxl",
                            "label": "t:sections.all.heading_size.options__4.label"
                        },
                        {
                            "value": "hxxl",
                            "label": "t:sections.all.heading_size.options__5.label"
                        }
                    ],
                    "default": "h1",
                    "label": "t:sections.all.heading_size.label"
                }
            ]
        },
        {
            "type": "paragraph",
            "name": "t:sections.promotion-popup.blocks.paragraph.name",
            "limit": 1,
            "settings": [
                {
                    "type": "richtext",
                    "id": "text",
                    "default": "<p>Describe what your customers will receive when subscribing to your newsletter.</p>",
                    "label": "t:sections.promotion-popup.blocks.paragraph.description.label"
                }
            ]
        },
        {
            "type": "email_form",
            "name": "t:sections.promotion-popup.blocks.email_form.name",
            "limit": 1
        },
        {
            "type": "button",
            "name": "t:sections.promotion-popup.blocks.button.name",
            "limit": 1,
            "settings": [
                {
                    "type": "text",
                    "id": "button_label",
                    "default": "Button label",
                    "label": "t:sections.promotion-popup.blocks.button.settings.button_label.label",
                    "info": "t:sections.promotion-popup.blocks.button.settings.button_label.info"
                },
                {
                    "type": "url",
                    "id": "button_link",
                    "label": "t:sections.promotion-popup.blocks.button.settings.link.label"
                },
                {
                    "type": "checkbox",
                    "id": "button_style_secondary",
                    "default": false,
                    "label": "t:sections.promotion-popup.blocks.button.settings.outline_button.label"
                }
            ]
        },
        {
            "type": "social_media",
            "name": "t:sections.promotion-popup.blocks.social-media.name",
            "limit": 1
        }
    ]
}
{% endschema %}