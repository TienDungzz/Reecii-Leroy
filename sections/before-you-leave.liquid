<before-you-leave
  data-expire-minutes="{{ section.settings.popup_expire_minutes }}"
>
  <div
    class="modal--popup fixed top-0 left-0 z-9 w-screen h-full flex-center no-js-hidden"
    id="before-you-leave-popup"
  >
    <div id="Modal-Overlay-{{ section.id }}" class="drawer__overlay fixed inset-0 cursor-pointer"></div>
    <div class="popup__inner w-auto color-{{ section.settings.color_scheme }} cus-scrollbar">
      <button
        type="button"
        class="popup__close button-close-circle"
        aria-label="{{ 'accessibility.close_dialog' | t }}"
      >
        <span class="svg-wrapper">
          {{- 'icon-close.svg' | inline_asset_content -}}
        </span>
        <span class="visually-hidden">{{ 'accessibility.close_dialog' | t }}</span>
      </button>

      {% content_for 'block', type: '_before-you-leave-group', id: 'before-you-leave-group' %}
    </div>
  </div>
</before-you-leave>

{% style %}
  before-you-leave .popup__inner {
    transform: none;
  }
  @media screen and (min-width: 750px) {
    before-you-leave .popup__inner {
      min-width: 90vw;
    }
  }

  @media screen and (min-width: 1025px) {
    before-you-leave .popup__inner {
      min-width: 96rem;
    }
  }
{% endstyle %}

<script defer="defer">
  class BeforeYouLeave extends HTMLElement {
    constructor() {
      super();
      this.popup = this.querySelector('.modal--popup');
      this.expiresMinutes = Number(this.dataset.expireMinutes) || 0;
      this.timeToShow = this.expiresMinutes * 60 * 1000;
      this.overlay = this.querySelector('[id^="Modal-Overlay-"]');
      this.content = this.querySelector('.popup__inner');

      this.idleTimer = null;
      this.boundReset = this.resetTimer.bind(this);
      this.boundCheck = this.checkIdle.bind(this);

      this.querySelector('.popup__close')?.addEventListener('click', () => this.setClosePopup());
      this.overlay?.addEventListener('click', () => this.setClosePopup());

      if (Shopify.designMode) {
        document.addEventListener('shopify:section:select', e => {
          if (e.target.matches('.section-before-you-leave')) this.setOpenPopup();
        });
        document.addEventListener('shopify:section:deselect', e => {
          if (e.target.matches('.section-before-you-leave')) this.setClosePopup();
        });
      }
    }

    connectedCallback() {
      if (!this.popup) return;

      if (!Shopify.designMode) {
        ['mousemove', 'keydown', 'scroll'].forEach(evt =>
          document.addEventListener(evt, this.boundReset)
        );
        this.startIdleTimer();
      }
    }

    disconnectedCallback() {
      if (Shopify.designMode) return;
      ['mousemove', 'keydown', 'scroll'].forEach(evt =>
        document.removeEventListener(evt, this.boundReset)
      );
      clearTimeout(this.idleTimer);
    }

    startIdleTimer() {
      clearTimeout(this.idleTimer);
      this.idleTimer = setTimeout(this.boundCheck, this.timeToShow);
    }

    resetTimer() {
      clearTimeout(this.idleTimer);
      this.startIdleTimer();
    }

    checkIdle() {
      if (!document.body.classList.contains('overflow-hidden')) this.setOpenPopup();
    }

    setOpenPopup() {
      if (!this.popup) return;
      this.popup.setAttribute('open', 'true');
      this.animateOpen();
      document.body.classList.add('overflow-hidden');
      document.documentElement.setAttribute('scroll-lock', '');
    }

    setClosePopup() {
      if (!this.popup) return;
      this.animateClose();
      this.startIdleTimer();
      setTimeout(() => {
        this.popup.removeAttribute('open');
        document.body.classList.remove('overflow-hidden');
        document.documentElement.removeAttribute('scroll-lock');
      }, 100);
    }

    animateOpen() {
      Motion.timeline([
        [this.overlay, { transform: ['translateY(-100%)', 'translateY(0)'] }, { duration: 0.3, easing: [0.61, 0.22, 0.23, 1] }],
        [this.content, { opacity: [0, 1], transform: ['translateY(2rem)', 'translateY(0)'] }, { duration: 0.3, at: '-0.15' }],
      ]).finished;
    }

    animateClose() {
      Motion.timeline([
        [this.content, { opacity: [1, 0], transform: ['translateY(0)', 'translateY(2rem)'] }, { duration: 0.2 }],
        [this.overlay, { transform: ['translateY(0)', 'translateY(100%)'] }, { duration: 0.2 }],
      ]).finished;
    }
  }

  if (!customElements.get('before-you-leave')) customElements.define('before-you-leave', BeforeYouLeave);
</script>

{% schema %}
{
  "name": "t:names.before_you_leave",
  "tag": "section",
  "class": "section-before-you-leave",
  "limit": 1,
  "enabled_on": {
    "groups": ["custom.popup"]
  },
  "settings": [
		{
			"type": "range",
			"id": "popup_expire_minutes",
			"max": 100,
			"min": 1,
			"step": 1,
			"unit": "min",
			"label": "t:settings.show_after_minutes",
			"default": 1
		},
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "t:names.before_you_leave",
      "blocks": {
        "before-you-leave-group": {
          "type": "_before-you-leave-group",
          "name": "t:names.group",
          "static": true,
          "settings": {
            "gap": 0
          },
          "blocks": {
            "banner": {
              "type": "_before-you-leave-banner",
              "name": "t:names.media_banner",
            },
            "content": {
              "type": "_before-you-leave-content",
              "name": "t:names.content",
              "settings": {
                "horizontal_alignment_flex_direction_column": "center",
                "gap": 24,
                "padding-block-start": 12,
                "padding-block-end": 12,
                "padding-inline-start": 12,
                "padding-inline-end": 12
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "settings": {
                    "text": "<h2>Before you leave</h2>"
                  }
                },
                "text": {
                  "type": "text",
                },
                "promotion_code": {
                  "type": "_input_promotion_code",
                  "settings": {
                    "promotion_popup_discount_code_text": "EXAMPLECODE"
                  }
                },
                "button": {
                  "type": "button",
                  "settings": {
                    "label": "Continue shopping"
                  }
                }
              },
              "block_order": ["heading", "text", "promotion_code", "button"]
            }
          },
          "block_order": ["banner", "content"]
        }
      }
    }
  ]
}
{% endschema %}
