<before-you-leave
  data-expire-minutes="{{ section.settings.popup_expire_minutes }}"
>
  <div
    class="modal--popup fixed top-0 left-0 z-9 w-screen h-full flex-center no-js-hidden"
    id="before-you-leave-popup"
  >
    <div id="Modal-Overlay-{{ section.id }}" class="drawer__overlay fixed inset-0 cursor-pointer"></div>
    <div class="popup__inner w-auto absolute-c-c flex flex-column color-{{ section.settings.color_scheme }}">
      <button
        type="button"
        class="popup__close"
        aria-label="{{ 'accessibility.close' | t }}"
      >
        {{- 'icon-close.svg' | inline_asset_content -}}
      </button>

      {% content_for 'blocks' %}
    </div>
  </div>
</before-you-leave>

{% style %}
  @media screen and (min-width: 750px) {
    before-you-leave .popup__inner {
      min-width: 90vw;
    }
  }

  @media screen and (min-width: 1025px) {
    before-you-leave .popup__inner {
      min-width: 96rem;
    }
  }
{% endstyle %}

<script defer="defer">
  class BeforeYouLeave extends HTMLElement {
    constructor() {
      super();
      this.popup = this.querySelector('.modal--popup');
      this.expiresMinutes = Number(this.dataset.expireMinutes) || 0;
      this.timeToShow = this.expiresMinutes * 60 * 1000;

      this.idleTimer = null;
      this.boundReset = this.resetTimer.bind(this);
      this.boundCheck = this.checkIdle.bind(this);
    }

    connectedCallback() {
      if (!this.popup) return;

      if (!Shopify.designMode) {
        ['mousemove', 'keydown', 'scroll'].forEach(evt =>
          document.addEventListener(evt, this.boundReset)
        );
        this.startIdleTimer();
      }

      this.querySelector('.popup__close')?.addEventListener('click', () => this.setClosePopup());
      this.querySelector('[id^="Modal-Overlay-"]')?.addEventListener('click', () => this.setClosePopup());

      if (Shopify.designMode) {
        document.addEventListener('shopify:section:select', e => {
          if (e.target.matches('.section-before-you-leave')) this.setOpenPopup();
        });
        document.addEventListener('shopify:section:deselect', e => {
          if (e.target.matches('.section-before-you-leave')) this.setClosePopup();
        });
      }
    }

    disconnectedCallback() {
      if (Shopify.designMode) return;
      ['mousemove', 'keydown', 'scroll'].forEach(evt =>
        document.removeEventListener(evt, this.boundReset)
      );
      clearTimeout(this.idleTimer);
    }

    startIdleTimer() {
      clearTimeout(this.idleTimer);
      this.idleTimer = setTimeout(this.boundCheck, this.timeToShow);
    }

    resetTimer() {
      clearTimeout(this.idleTimer);
      this.startIdleTimer();
    }

    checkIdle() {
      if (!document.body.classList.contains('overflow-hidden')) this.setOpenPopup();
    }

    setOpenPopup() {
      if (!this.popup) return;
      this.popup.setAttribute('open', 'true');
      document.body.classList.add('overflow-hidden');
    }

    setClosePopup() {
      if (!this.popup) return;
      this.popup.removeAttribute('open');
      document.body.classList.remove('overflow-hidden');
      this.startIdleTimer();
    }
  }

  if (!customElements.get('before-you-leave')) customElements.define('before-you-leave', BeforeYouLeave);
</script>

{% schema %}
{
  "name": "t:names.before_you_leave",
  "tag": "section",
  "class": "section-before-you-leave",
  "limit": 1,
  "enabled_on": {
    "groups": ["custom.popup"]
  },
  "blocks": [
    {
      "type": "_before-you-leave-group"
    }
  ],
  "settings": [
		{
			"type": "range",
			"id": "popup_expire_minutes",
			"max": 100,
			"min": 1,
			"step": 1,
			"unit": "min",
			"label": "t:settings.show_after_minutes",
			"default": 1
		},
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "t:names.before_you_leave",
      "blocks": {
        "group": {
          "type": "_before-you-leave-group",
          "settings": {
            "content_direction": "row",
            "gap": 0
          },
          "blocks": {
            "banner": {
              "type": "_before-you-leave-banner",
              "name": "t:names.media_banner",
            },
            "content": {
              "type": "_before-you-leave-content",
              "name": "t:names.content",
              "settings": {
                "horizontal_alignment_flex_direction_column": "center",
                "gap": 24,
                "padding-block-start": 12,
                "padding-block-end": 12,
                "padding-inline-start": 12,
                "padding-inline-end": 12
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "settings": {
                    "text": "<h2>Before you leave</h2>"
                  }
                },
                "text": {
                  "type": "text",
                },
                "promotion_code": {
                  "type": "_input_promotion_code",
                  "settings": {
                    "promotion_popup_discount_code_text": "EXAMPLECODE"
                  }
                },
                "button": {
                  "type": "button",
                  "settings": {
                    "label": "Continue shopping"
                  }
                }
              },
              "block_order": ["heading", "text", "promotion_code", "button"]
            }
          },
          "block_order": ["banner", "content"]
        }
      },
      "block_order": ["group"]
    }
  ]
}
{% endschema %}
