<link
  rel="stylesheet"
  href="{{ 'component-before-you-leave.css' | asset_url }}"
  media="print"
  onload="this.media='all'"
>
<noscript>{{ 'component-before-you-leave.css' | asset_url | stylesheet_tag }}</noscript>

<before-you-leave
  class="modal--popup halo-newsletter-popup modal--popup fixed top-0 left-0 z-9 w-screen h-full flex-center no-js-hidden"
  open
  data-newsletter-popup
  data-delay="{{ section.settings.newsletter_popup_delay | times:1000 }}"
  data-expire="{{ section.settings.newsletter_popup_expire }}"
  id="halo-newsletter-popup"
>
  <div id="Modal-Overlay" class="drawer__overlay fixed inset-0 cursor-pointer"></div>
  <div class="popup__inner w-auto h-full absolute-c-c flex flex-column global-settings-popup">
    <button
      type="button"
      class="halo-popup-close clearfix"
      data-close-newsletter-popup
      aria-label="{{ 'accessibility.close' | t }}"
    >
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>
    <div class="halo-popup-banner">
      {%- assign image = section.settings.promotion_popup_image -%}
      <div class="banner__media">
        {%- if section.settings.promotion_popup_image != blank -%}
          {% comment %}
            <img
              srcset="{{ image | img_url: '1000x' }}"
              src="{{ image | img_url: '1000x' }}"
              {% if settings.enable_lazyload %}
                loading="lazy"
              {% endif %}
              alt="{{ image.alt | default: shop.name | escape }}"
            >
          {% endcomment %}
        {%- else -%}
          <div class="placeholder" style="--height_placeholder: 580px;">
            {{ 'blog-apparel-3' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {%- endif -%}
      </div>
      <div class="banner__content">
        <div class="banner__box">
          {%- if section.settings.promotion_popup_title != blank -%}
            <h3 class="newsletter-popup-title text-center">{{ section.settings.promotion_popup_title }}</h3>
          {%- endif -%}
          {%- if section.settings.promotion_popup_discount_label != blank -%}
            <span class="halo-popup-desc text-center">
              <span class="discount_label">{{ section.settings.promotion_popup_discount_label }}</span>
              <p class="discount_info">{{ section.settings.promotion_popup_discount_info }}</p>
            </span>
          {%- endif -%}
          {% if section.settings.promotion_popup_discount_code_text != blank %}
            <div class="code-input_wrapper">
              <div class="code__input">
                <input
                  class="field__input"
                  type="text"
                  value="{{ section.settings.promotion_popup_discount_code_text }}"
                  readonly
                >
                <button class="button-code--copy">
                  {% render 'icon-copy' %}
                  <span class="tooltip" data-success_message="{{ 'general.copied' | t }}">
                    {{ 'general.copy' | t }}
                  </span>
                </button>
              </div>
              <div class="code-popup__desc">
                <p>{{ section.settings.promotion_popup_discount_code_des }}</p>
              </div>
            </div>
          {% endif %}
          {% if section.settings.button_promotion_text != blank %}
            <a
              class="button button--primary newsletter-form__button"
              {% if section.settings.button_promotion_link == blank %}
                href="{{ routes.all_products_collection_url }}"
              {% else %}
                href="{{ section.settings.button_promotion_link }}"
              {% endif %}
            >
              {{- section.settings.button_promotion_text -}}
            </a>
          {% endif %}
          {% if section.settings.show_social_promotion %}
            {% render 'halo-social-media-icons' %}
          {% endif %}
          {%- if section.settings.promotion_popup_note != blank -%}
            <div class="newsletter--checked text-center">
              <input id="dismiss" type="checkbox" name="dismiss" hidden>
              <label for="dismiss" class="form-label--checkbox" role="text">
                {{- section.settings.promotion_popup_note -}}
              </label>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
    {% if section.settings.show_recommended_products %}
      <div class="halo-popup-wrapper">
        <div class="popup__product">
          {% if section.settings.promotion_products_recommended_text != blank %}
            <h3 class="popup__product-title">{{ section.settings.promotion_products_recommended_text }}</h3>
          {% endif %}
          <div
            class="products-grid column-2"
            style="
              --product-vendor-font-size: 12px;
              --product-vendor-line-height: 1.3;
              --product-title-font-size: 16px;
              --product-title-line-height: 1.3;
              --product-price-font-size: 14px;
              --product-price-line-height: 1.3;
            "
          >
            {% if section.settings.promotion_products_recommended_list != blank %}
              {%- for product in section.settings.promotion_products_recommended_list -%}
                <div class="product">
                  {% render 'resource-card',
                    resource_type: 'product',
                    resource: product,
                    image_width: 500,
                    image_hover: true,
                    image_aspect_ratio: '4 / 5'
                  %}
                </div>
              {%- endfor -%}
            {% else %}
              {%- for i in (1..2) -%}
                <div class="product{% if swipe %} slider__slide grid__item{% endif %}">
                  {% capture current %}{% cycle 1, 2, 3, 4 %}{% endcapture %}
                  {% render 'product-card-placeholder', index: current %}
                </div>
              {%- endfor -%}
            {% endif %}
          </div>
          {% if section.settings.continue_shopping_label != blank %}
            <a
              {% if section.settings.continue_shopping_link == blank %}
                href="{{ routes.all_products_collection_url }}"
              {% else %}
                href="{{ section.settings.continue_shopping_link }}"
              {% endif %}
              class="button button--primary button-continue"
            >
              {{- section.settings.continue_shopping_label -}}
              {{- 'icon-arrow.svg' | inline_asset_content -}}
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</before-you-leave>

{% schema %}
{
  "name": "Before you leave",
  "tag": "section",
  "class": "shopify-section--popup section--before-you-leave",
  "limit": 1,
  "enabled_on": {
    "groups": ["custom.popup"]
  },
  "settings": [
    {
      "type": "range",
      "id": "newsletter_popup_expire",
      "label": "Show again after",
      "max": 30,
      "min": 1,
      "step": 1,
      "unit": "day",
      "default": 1
    },
    {
      "type": "range",
      "id": "newsletter_popup_delay",
      "label": "Delay time",
      "max": 60,
      "min": 5,
      "step": 1,
      "unit": "s",
      "default": 5
    },
    {
      "type": "header",
      "content": "Newsletter"
    },
    {
      "type": "checkbox",
      "id": "show_newsletter_popup_image",
      "label": "Show image",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "newsletter_popup_image",
      "label": "Image"
    },
    {
      "type": "url",
      "id": "popup_newsletter_link_image",
      "label": "Link"
    },
    {
      "type": "text",
      "id": "newsletter_popup_title",
      "label": "Title"
    },
    {
      "type": "liquid",
      "id": "newsletter_popup_desc",
      "label": "t:sections.image-banner.blocks.image.settings.content.label__2"
    },
    {
      "type": "liquid",
      "id": "newsletter_popup_note",
      "label": "Note"
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "select",
      "id": "select_button_submit",
      "label": "Type",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "default"
    },
    {
      "type": "url",
      "id": "button_newsletter_link",
      "label": "Link",
      "info": "Use for custom link."
    },
    {
      "type": "header",
      "content": "Promotion"
    },
    {
      "type": "image_picker",
      "id": "promotion_popup_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "promotion_popup_title",
      "label": "Title",
      "default": "Special Offer"
    },
    {
      "type": "inline_richtext",
      "id": "promotion_popup_discount_label",
      "label": "Discount label",
      "default": "<strong>30% OFF</strong>"
    },
    {
      "type": "inline_richtext",
      "id": "promotion_popup_discount_info",
      "label": "Discount info",
      "default": "<em>on your first purchase</em>"
    },
    {
      "type": "text",
      "id": "promotion_popup_discount_code_text",
      "label": "Discount code text",
      "default": "CODEWHERE"
    },
    {
      "type": "text",
      "id": "promotion_popup_discount_code_des",
      "label": "Discount code description",
      "default": "Copy the code above for 30% discound"
    },
    {
      "type": "textarea",
      "id": "promotion_popup_note",
      "label": "Note",
      "default": "Don't show this again!"
    },
    {
      "type": "text",
      "id": "button_promotion_text",
      "label": "Button text",
      "default": "GET DISCOUND"
    },
    {
      "type": "url",
      "id": "button_promotion_link",
      "label": "Link"
    },
    {
      "type": "checkbox",
      "id": "show_social_promotion",
      "label": "Show social media links",
      "default": true
    },
    {
      "type": "paragraph",
      "content": "Recommended products"
    },
    {
      "type": "checkbox",
      "id": "show_recommended_products",
      "label": "Show recommended products",
      "default": true
    },
    {
      "type": "text",
      "id": "promotion_products_recommended_text",
      "label": "Recommended products text",
      "default": "Recommended products"
    },
    {
      "type": "product_list",
      "limit": 8,
      "id": "promotion_products_recommended_list",
      "label": "Recommended products list"
    },
    {
      "type": "text",
      "id": "continue_shopping_label",
      "label": "Continue shopping label",
      "default": "Continue Shopping"
    },
    {
      "type": "url",
      "id": "continue_shopping_link",
      "label": "Link"
    }
  ],
  "presets": [
    {
      "name": "Before you leave",
      "settings": {}
    }
  ]
}
{% endschema %}

<script>
  class BeforeYouLeave extends HTMLElement {
    constructor() {
      super();

      this.popup = this;
      this.timeToShow = parseInt(this.popup.getAttribute('data-delay'));
      this.expiresDate = this.popup.getAttribute('data-expire');
      if (this.getCookie('newsletter-popup') === '') {
        var popup = this.popup;

        setTimeout(function () {
          // document.body.classList.add('newsletter-show');
          this.popup.setAttribute('open', '');
        }, this.timeToShow);

        setTimeout(() => {
          document.body.classList.add('show-newsletter-image');
        }, this.timeToShow + 700);
      } else {
        // this.deleteCookie('newsletter-popup');
      }

      document.body.addEventListener('click', this.onBodyClickEvent.bind(this));

      this.querySelector('[data-close-newsletter-popup]').addEventListener('click', this.setClosePopup.bind(this));

      this.querySelector('#ContactPopup')?.addEventListener('submit', this.setClosePopup.bind(this));

      this.dismissLabel = this.querySelector('label[for="dismiss"]');
      if (this.dismissLabel) {
        this.dismissLabel.addEventListener('click', this.setClosePopup.bind(this));
      }

      if (this.classList.contains('style-2')) {
        this.copyButton = this.querySelector('.button-code--copy');
        if (this.copyButton) {
          this.copyButton.addEventListener('click', () => {
            this.inputField = this.querySelector('.code__input .field__input');
            this.tooltip = this.copyButton.querySelector('.tooltip');
            navigator.clipboard.writeText(this.inputField.value).then(() => {
              this.tooltip.textContent = this.tooltip.dataset.success_message;
            });
          });
        }
      }
    }

    setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
      const expires = 'expires=' + d.toUTCString();
      document.cookie = cname + '=' + cvalue + ';' + expires + ';path=/';
    }

    getCookie(cname) {
      const name = cname + '=';
      const ca = document.cookie.split(';');

      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
          return c.substring(name.length, c.length);
        }
      }

      return '';
    }

    deleteCookie(name) {
      document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    }

    setClosePopup() {
      this.setCookie('newsletter-popup', 'closed', this.expiresDate);
      // document.body.classList.remove('newsletter-show');
      this.popup.removeAttribute('open');
      setTimeout(() => {
        document.body.classList.remove('show-newsletter-image');
      }, 700);
    }

    onBodyClickEvent(event) {
      if (
        !this.contains(event.target) &&
        $(event.target).closest('[data-open-newsletter-popup]').length === 0 &&
        // document.querySelector('body').classList.contains('newsletter-show')
        this.popup.hasAttribute('open')
      ) {
        this.setClosePopup();
      }
    }
  }

  customElements.define('before-you-leave', BeforeYouLeave);
</script>
