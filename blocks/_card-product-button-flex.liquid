{%- liquid
  assign section_id = section.id
  assign block_id = block.id
  assign card_product = block.settings.product
  assign quick_add = block.settings.quick_add

  assign quick_add_type_icon = false
  if settings.quick_add_type == 'icon'
    assign quick_add_type_icon = true
    assign class_button = 'card-product__group-btn rounded-full bor-none center cursor-pointer flex items-center justify-center relative w-fit leading-none'
    assign class_text = 'text whitespace-nowrap overflow-hidden pointer-events-none absolute-c-y z--1 opacity-0'
    assign class_text_inner = 'text-inner text-sm inline-block'
  else
    assign padding_block = block.settings.padding_block | times: 0.1 | append: 'rem'
    assign padding_inline = block.settings.padding_inline | times: 0.1 | append: 'rem'
  endif
-%}

{%- if card_product and card_product != empty and block.settings.quick_add != 'none' -%}
  <div
    class="card--block-button {{ block.settings.quick_add }} relative z-2 w-full"
    style="{% if quick_add_type_icon %}--pl: 0; --pr: 0;--md-pl: 1rem; --md-pr: 1rem;--lg-pl: 1.6rem; --lg-pr: 1.6rem;{% else %}--p: {{ padding_block }} {{ padding_inline }};{% if block.settings.background %}--bg-color: {{ block.settings.background_color }}; --corner-radius: {{ block.settings.corner_radius }}px;{% endif %}{% endif %}"
  >
    {% assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id | append: block_id %}
    {% if quick_add == 'standard' %}
      <div class="quick-add">
        {%- liquid
          assign qty_rules = false
          if card_product.selected_or_first_available_variant.quantity_rule.min > 1 or card_product.selected_or_first_available_variant.quantity_rule.max != null or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
            assign qty_rules = true
          endif
        -%}
        {%- if card_product.variants.size > 1 or qty_rules -%}
          <modal-opener data-modal="#QuickAddStandard">
            <button
              id="{{ product_form_id }}-submit"
              type="submit"
              name="add"
              class="quick-add__submit quick-add__submit--{{ settings.quick_add_type }} button button--full-width {% if horizontal_quick_add %} card--horizontal__quick-add animate-arrow{% endif %} {{ class_button }}"
              aria-haspopup="dialog"
              aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
              data-product-url="{{ card_product.url }}?view=quick_add"
            >
              {%- if quick_add_type_icon == false -%}
                {{ 'products.product.choose_options' | t }}
              {%- else -%}
                <span class="text-in-mb md:hidden">
                  {{ 'products.product.choose_options' | t }}
                </span>
                <span class="{{ class_text }}">
                  <span class="{{ class_text_inner }}">{{ 'products.product.choose_options' | t }}</span>
                </span>
                {%- render 'icon', icon: 'cart', class: 'max-sm:hidden' -%}
              {%- endif -%}

              {%- if horizontal_quick_add -%}
                <span class="icon-wrap">
                  {{- 'icon-arrow.svg' | inline_asset_content -}}
                </span>
              {%- endif -%}
              {%- render 'loading-spinner' -%}
            </button>
          </modal-opener>
        {%- else -%}
          <product-form data-section-id="{{ section_id }}">
            {%- form 'product',
              card_product,
              id: product_form_id,
              class: 'form',
              novalidate: 'novalidate',
              data-type: 'add-to-cart-form'
            -%}
              <input
                type="hidden"
                name="id"
                value="{{ card_product.selected_or_first_available_variant.id }}"
                class="product-variant-id"
                {% if card_product.selected_or_first_available_variant.available == false %}
                  disabled
                {% endif %}
              >
              <button
                id="{{ product_form_id }}-submit"
                type="submit"
                name="add"
                class="quick-add__submit button button--full-width button-secondary{% if horizontal_quick_add %} card--horizontal__quick-add{% endif %}"
                aria-haspopup="dialog"
                aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                aria-live="polite"
                data-sold-out-message="true"
                {% if card_product.selected_or_first_available_variant.available == false %}
                  disabled
                {% endif %}
              >
                <span>
                  {%- if card_product.selected_or_first_available_variant.available -%}
                    {{ 'products.product.add_to_cart' | t }}
                  {%- else -%}
                    {{ 'products.product.sold_out' | t }}
                  {%- endif -%}
                </span>
                <span class="sold-out-message hidden">
                  {{ 'products.product.sold_out' | t }}
                </span>
                {%- if horizontal_quick_add -%}
                  <span class="icon-wrap">
                    {{- 'icon-plus.svg' | inline_asset_content -}}
                  </span>
                {%- endif -%}
                {%- render 'loading-spinner' -%}
              </button>
            {%- endform -%}
          </product-form>
        {%- endif -%}
      </div>
    {% elsif quick_add == 'bulk' %}
      <div class="quick-add">
        {%- if card_product.variants.size > 1 -%}
          <modal-opener data-modal="#QuickAddBulk">
            <button
              id="{{ product_form_id }}-submit"
              type="submit"
              name="add"
              class="quick-add__submit button button--full-width button-secondary"
              aria-haspopup="dialog"
              aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
              data-product-url="{{ card_product.url }}"
            >
              {%- if settings.quick_add_type == 'text' -%}
                {{ 'products.product.choose_options' | t }}
              {%- else -%}
                {%- render 'icon', icon: 'cart' -%}
              {%- endif -%}

              {%- render 'loading-spinner' -%}
            </button>
          </modal-opener>
        {%- else -%}
          <quick-add-bulk
            data-min="{{ card_product.selected_or_first_available_variant.quantity_rule.min }}"
            class="quick-add-bulk no-js-hidden"
            id="quick-add-bulk-{{ card_product.selected_or_first_available_variant.id }}"
            data-index="{{ card_product.selected_or_first_available_variant.id }}"
          >
            {% if card_product.selected_or_first_available_variant.available == false %}
              <button
                id="{{ product_form_id }}-submit"
                type="submit"
                name="add"
                class="quick-add__submit button button--full-width button-secondary"
                aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                data-sold-out-message="true"
                disabled
              >
                <span>{{ 'products.product.sold_out' | t }}</span>
                <span class="sold-out-message hidden">
                  {{ 'products.product.sold_out' | t }}
                </span>
              </button>
            {% else %}
              {% render 'quantity-input', variant: card_product.selected_or_first_available_variant, min: 0 %}
            {% endif %}
          </quick-add-bulk>
          <noscript>
            <product-form data-section-id="{{ section_id }}">
              {%- form 'product',
                card_product,
                id: product_form_id,
                class: 'form',
                novalidate: 'novalidate',
                data-type: 'add-to-cart-form'
              -%}
                <input
                  type="hidden"
                  name="id"
                  value="{{ card_product.selected_or_first_available_variant.id }}"
                  class="product-variant-id"
                  {% if card_product.selected_or_first_available_variant.available == false %}
                    disabled
                  {% endif %}
                >
                <button
                  id="{{ product_form_id }}-submit"
                  type="submit"
                  name="add"
                  class="quick-add__submit button button--full-width button-secondary{% if horizontal_quick_add %} card--horizontal__quick-add{% endif %}"
                  aria-haspopup="dialog"
                  aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                  aria-live="polite"
                  data-sold-out-message="true"
                  {% if card_product.selected_or_first_available_variant.available == false %}
                    disabled
                  {% endif %}
                >
                  <span>
                    {%- if card_product.selected_or_first_available_variant.available -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- else -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- endif -%}
                  </span>
                  <span class="sold-out-message hidden">
                    {{ 'products.product.sold_out' | t }}
                  </span>
                  {%- if horizontal_quick_add -%}
                    <span class="icon-wrap">
                      {{- 'icon-plus.svg' | inline_asset_content -}}
                    </span>
                  {%- endif -%}
                  {%- render 'loading-spinner' -%}
                </button>
              {%- endform -%}
            </product-form>
          </noscript>
        {%- endif -%}
      </div>
    {% endif %}
  </div>
{%- endif -%}

{%- if quick_add != 'none' -%}
  {%- liquid
    assign files = 'product-form.js'

    if quick_add == 'standard'
      assign files = files | append: ', quick-add.js'
    endif

    if quick_add == 'bulk'
      assign files = files | append: ', quick-add-bulk.js, quantity-popover.js, price-per-item.js, quick-order-list.js'
    endif

    assign files = files | split: ', '
    render 'theme-loader', files: files
  -%}
{%- endif -%}

{%- stylesheet -%}
  /* .quick-add {
  position: relative;
  grid-row-start: 4;
  margin: 0.5rem 0;
  z-index: 1;
  @media screen and (width >= 750px) {
    margin: 1rem 0;
  }
} */

  .section-bulk-quick-order-list-padding {
    padding-block: 2.7rem;
  }

  @media screen and (min-width: 750px) {
    .section-bulk-quick-order-list-padding {
      padding-block: 3.6rem;
    }
  }
  .quick-add__product-media {
    margin-bottom: 1rem;
  }

  .quick-add__submit {
    padding: 0.8rem;
    min-width: 100%;
    box-sizing: border-box;
    line-height: 1;
    text-transform: uppercase;

    &.card-product__group-btn {
      padding: 0;
      color: var(--button-color);
      background-color: var(--button-background-color);
      min-height: initial;

      .text {
        color: var(--button-color);
        background-color: var(--button-background-color);
      }

      &:hover {
        --button-color: var(--color-primary-button-hover-text);
        --button-background-color: var(--color-primary-button-hover-background);
        color: var(--button-color);
        background-color: var(--button-background-color);

        .text {
          color: var(--button-color);
          background-color: var(--button-background-color);
        }
      }
    }
  }

  quick-add-bulk {
    position: relative;
    grid-row-start: 4;
    margin: 0 0 1rem;
    z-index: 1;
  }

  .card__content quick-add-bulk .quantity {
    width: 100%;
  }

  quick-add-bulk .progress-bar-container {
    position: absolute;
    height: 100%;
    display: flex;
    overflow: hidden;
    border-radius: var(--inputs-radius-outset);
    border: var(--inputs-border-width) solid transparent;
    z-index: -1;
  }

  quick-add-bulk quantity-input {
    justify-content: space-between;
  }

  quick-add-bulk .quantity__input {
    max-width: calc(6.5rem / var(--font-body-scale));
    flex-grow: 0;
  }

  .quantity__input-disabled {
    pointer-events: none;
  }

  /* Quick add main */
  .product-quick-add {
    .product__vendor,
    .product__title {
      margin-bottom: 0.5rem;
    }

    .product .price__container {
      margin-bottom: 0;
    }

    @media screen and (width >= 750px) {
      .product__info-wrapper {
        padding: 2rem 0 0;
      }
    }

    .price__container {
      display: block;
    }
  }

  .product-quick-add__header {
    padding-right: 5rem;
    .product__media-wrapper {
      @media screen and (width >= 750px) {
        max-width: 90px;
      }
    }
  }
{%- endstylesheet -%}

{% schema %}
{
  "name": "Product button",
  "tag": null,
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "t:sections.collage.blocks.product.settings.product.label"
    },
    {
      "type": "select",
      "id": "quick_add",
      "default": "none",
      "label": "t:sections.main-collection-product-grid.settings.quick_add.label",
      "info": "t:sections.main-collection-product-grid.settings.quick_add.info",
      "options": [
        {
          "value": "none",
          "label": "t:sections.main-collection-product-grid.settings.quick_add.options.option_1"
        },
        {
          "value": "standard",
          "label": "t:sections.main-collection-product-grid.settings.quick_add.options.option_2"
        },
        {
          "value": "bulk",
          "label": "t:sections.main-collection-product-grid.settings.quick_add.options.option_3"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:content.appearance",
      "visible_if": "{{ settings.quick_add_type == 'text' }}"
    },
    {
      "type": "checkbox",
      "id": "background",
      "label": "t:settings.background",
      "default": false,
      "visible_if": "{{ settings.quick_add_type == 'text' }}"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "t:settings.background_color",
      "alpha": true,
      "default": "#000",
      "visible_if": "{{ block.settings.background and settings.quick_add_type == 'text' }}"
    },
    {
      "type": "range",
      "id": "corner_radius",
      "label": "t:settings.corner_radius",
      "default": 0,
      "min": 0,
      "max": 50,
      "step": 1,
      "visible_if": "{{ block.settings.background and settings.quick_add_type == 'text' }}"
    },
    {
      "type": "header",
      "content": "Padding",
      "visible_if": "{{ settings.quick_add_type == 'text' }}"
    },
    {
      "type": "range",
      "id": "padding_block",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "label": "Top/Bottom",
      "unit": "px",
      "visible_if": "{{ settings.quick_add_type == 'text' }}"
    },
    {
      "type": "range",
      "id": "padding_inline",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "label": "Left/Right",
      "unit": "px",
      "visible_if": "{{ settings.quick_add_type == 'text' }}"
    }
  ],
  "presets": [
    {
      "name": "Product button",
      "settings": {
        "product": "{{ closest.product }}"
      }
    }
  ]
}
{% endschema %}
