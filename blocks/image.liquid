{% liquid
  assign ratio = 1

  case block.settings.image_ratio
    when 'landscape'
      assign ratio = '16 / 9'
    when 'portrait'
      assign ratio = '4 / 5'
    when 'adapt'
      assign ratio = block.settings.image.aspect_ratio
  endcase

  if ratio == 0 or ratio == null
    assign ratio = 1
  endif

  assign image = block.settings.image
  assign image_height = block.settings.image.height
  assign image_height_2x = image_height | times: 2
  assign image_width = block.settings.image.width
  assign image_width_2x = image_width | times: 2
  assign image_aspect_ratio = block.settings.image.aspect_ratio
%}

{% capture class %}
  image-block image-block--{{ block.id }} image-block--height-{{ block.settings.height }} spacing-style size-style border-style{% if block.settings.hide_on_mobile %} max-sm:hidden{% endif %}
{% endcapture %}

{% capture style %}
  --ratio: {{ ratio }};
  {% render 'size-style', settings: block.settings %}
  {% render 'spacing-style', settings: block.settings %}
  {% render 'border-override', settings: block.settings %}
{% endcapture %}

{% liquid
  assign media_width_desktop = '100vw'
  assign media_width_mobile = '100vw'
  assign sizes = 'auto, (min-width: 750px) ' | append: media_width_desktop | append: ', ' | append: media_width_mobile
  assign widths = '300, 450, 600, 750, 900, 1050, 1200, 1350, 1500, 1650, 1800, 1950, 2000, 2500, 3000, 3500, 4000, 5000'

  assign element = 'div'
  if block.settings.enable_fancybox
    assign element = 'a'
  elsif block.settings.enable_parallax
    assign element = 'parallax-image'
  endif
%}
{%- if block.settings.enable_fancybox -%}
  {%- render 'photoswipe_lib' -%}
{%- endif -%}

{% capture class_img %}
  image-block__image{% if block.settings.enable_parallax %} image-parallax--target{% endif %}
{% endcapture %}

{% comment %} href="{{ image | image_url : width: image_width_2x , height: image_height_2x  }}" {% endcomment %}
{% capture attributes_fancybox %}
  href="{{ block.settings.fancybox_link }}"
  data-pswp-src="{{ image | image_url : width: image_width_2x , height: image_height_2x  }}"
  data-pswp-width="{{ image_width_2x  }}"
  data-pswp-height="{{ image_height_2x }}"
  data-pswp-video-src="my-video.mp4"
  target="_blank"
{% endcapture %}

{% capture attributes_parllax %}
  data-parallax="true"
  data-speed="{{ block.settings.parallax_speed }}"
{% endcapture %}

{% capture attributes %}
  {{ block.shopify_attributes }}
  {% if block.settings.enable_fancybox %}
    {{ attributes_fancybox }}
  {% endif %}
  {% if block.settings.enable_parallax %}
    {{ attributes_parllax }}
  {% endif %}
{% endcapture %}

<{{ element }}
  class="{{ class }}"
  style="{{ style }}"
  {{ attributes }}
>
  {%- if image != blank -%}
    {%- render 'image',
      image: image,
      class: class_img,
      height: image.height,
      sizes: sizes,
      widths: widths
    -%}
  {%- else -%}
    {{ 'hero-apparel-1' | placeholder_svg_tag: 'image-block__image placeholder-svg' }}
  {%- endif -%}
</{{ element }}>

{%- if block.settings.enable_fancybox -%}
  <script type="module">
    import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.min.js';
    import PhotoSwipeVideoPlugin from 'https://raw.githubusercontent.com/dimsemenov/photoswipe-video-plugin/refs/heads/main/dist/photoswipe-video-plugin.esm.js';
    if (!window._myScriptLoaded) {

      window._myScriptLoaded = true;

      const sections = document.querySelectorAll('.section');

      sections.forEach((section, index) => {
        const uniqueGalleryID = `gallery-${index}`;

        section.querySelectorAll('a[data-pswp-width]').forEach((el) => {
          el.setAttribute('data-pswp-gallery', uniqueGalleryID);
        });

        const lightbox = new PhotoSwipeLightbox({
          gallery: section,
          children: 'a[data-pswp-gallery="' + uniqueGalleryID + '"]',
          pswpModule: () => import('https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js'),
        });

        const videoPlugin = new PhotoSwipeVideoPlugin(lightbox, {
          // options
        });

        lightbox.init();
      });
    }
  </script>
{%- endif -%}

{%- stylesheet -%}
  .image-block {
    display: flex;

    /* When the image is nested in a group, section, etc, respect the parent's horizontal alignment */
    justify-content: var(--horizontal-alignment, 'inline-start');
  }

  .image-block--height-fill .image-block__image {
    height: 100%;
  }

  .image-block__image {
    object-fit: cover;
    aspect-ratio: var(--ratio);
  }
{%- endstylesheet -%}

{% schema %}
{
  "name": "Image",
  "tag": null,
  "settings": [
    {
      "type": "image_picker",
      "id": "image",
      "label": "t:sections.all.image.name"
    },
    {
      "type": "url",
      "id": "link",
      "label": "Link",
      "visible_if": "{{ block.settings.enable_fancybox == false }}"
    },
    {
      "type": "url",
      "id": "fancybox_link",
      "label": "Fancybox link",
      "visible_if": "{{ block.settings.enable_fancybox }}"
    },
    {
      "type": "checkbox",
      "id": "hide_on_mobile",
      "label": "Hide on mobile",
      "default": false
    },
    {
      "type": "header",
      "content": "Size"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:sections.main-collection-product-grid.settings.image_ratio.options__1.label"
        },
        {
          "value": "portrait",
          "label": "t:sections.main-collection-product-grid.settings.image_ratio.options__2.label"
        },
        {
          "value": "square",
          "label": "t:sections.main-collection-product-grid.settings.image_ratio.options__3.label"
        }
      ],
      "default": "adapt",
      "label": "t:sections.main-collection-product-grid.settings.image_ratio.label"
    },
    {
      "type": "select",
      "id": "width",
      "label": "Desktop width",
      "options": [
        {
          "value": "fit-content",
          "label": "Fit"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "range",
      "id": "custom_width",
      "label": "Custom (%)",
      "min": 1,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width == 'custom' }}"
    },
    {
      "type": "select",
      "id": "width_tablet",
      "label": "Tablet width",
      "options": [
        {
          "value": "fit-content",
          "label": "Fit"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "range",
      "id": "custom_width_tablet",
      "label": "Custom (%)",
      "min": 1,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width_tablet == 'custom' }}"
    },
    {
      "type": "select",
      "id": "width_mobile",
      "label": "Mobile width",
      "options": [
        {
          "value": "fit-content",
          "label": "Fit"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "range",
      "id": "custom_width_mobile",
      "label": "Custom (%)",
      "min": 1,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width_mobile == 'custom' }}"
    },
    {
      "type": "select",
      "id": "height",
      "label": "t:settings.height",
      "options": [
        {
          "value": "fit",
          "label": "t:options.fit_content"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        }
      ],
      "default": "fit",
      "visible_if": "{{ block.settings.image_ratio == 'adapt' }}"
    },
    {
      "type": "header",
      "content": "t:settings_schema.global.settings.header__border.content"
    },
    {
      "type": "select",
      "id": "border",
      "label": "t:settings.style",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "solid",
          "label": "Solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "t:settings_schema.global.settings.thickness.label",
      "default": 1,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "t:settings_schema.global.settings.opacity.label",
      "default": 100,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "t:settings_schema.global.settings.corner_radius.label",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "checkbox",
      "id": "enable_fancybox",
      "label": "Enable Fancybox",
      "default": false,
      "visible_if": "{{ block.settings.enable_parallax == false }}"
    },
    {
      "type": "checkbox",
      "id": "enable_parallax",
      "label": "Enable parallax scroll",
      "default": false,
      "visible_if": "{{ block.settings.enable_fancybox == false }}"
    },
    {
      "type": "range",
      "id": "parallax_speed",
      "label": "Parallax speed",
      "min": 0,
      "max": 4,
      "step": 0.5,
      "default": 0.5,
      "visible_if": "{{ block.settings.enable_fancybox == false and block.settings.enable_parallax }}"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "label": "t:settings_schema.global.settings.spacing.spacing_top.label"
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "label": "t:settings_schema.global.settings.spacing.spacing_right.label"
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "label": "t:settings_schema.global.settings.spacing.spacing_bottom.label"
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "label": "t:settings_schema.global.settings.spacing.spacing_left.label"
    }
  ],
  "presets": [
    {
      "name": "Image",
      "category": "Basic"
    }
  ]
}
{% endschema %}
