{% liquid
  assign text_1 = block.settings.text_1 | truncate: 20
  assign text_2 = block.settings.text_2 | truncate: 20
  assign text_3 = block.settings.text_3 | truncate: 20
  assign stop_on_hover = block.settings.stop_on_hover
  assign text_color = block.settings.text_color
  assign circle_color = block.settings.circle_color
%}

{%- capture style_attributes -%}
    --text-color: {{ text_color }};
    --circle-color: {{ circle_color }};
{%- endcapture -%}

<div class="circle-container{% if stop_on_hover %} stop-on-hover{% endif %}" style="{{ style_attributes }}">
  <div class="play-icon"></div>
  {% if text_1 != blank or text_2 != blank or text_3 != blank %}
    <svg class="textcircle" viewBox="0 0 500 500">
      <defs>
        <path id="textcircle" d="M250,400 a150,150 0 0,1 0,-300a150,150 0 0,1 0,300Z"></path>
      </defs>
      <text vertical-align="middle">
        {% if text_1 != blank %}
          <textPath xlink:href="#textcircle" startOffset="0%">
            {{ text_1 }}
          </textPath>
        {% endif %}
        {% if text_2 != blank %}
          <textPath xlink:href="#textcircle" startOffset="33%">
            {{ text_2 }}
          </textPath>
        {% endif %}
        {% if text_3 != blank %}
          <textPath xlink:href="#textcircle" startOffset="66%">
            {{ text_3 }}
          </textPath>
        {% endif %}
      </text>
    </svg>
  {% endif %}
<script>
  (function() {
    function resizeTextCircle(svg) {
      if (!svg) return;
      try {
        var text = svg.querySelector('text');
        if (!text) return;
        var bbox = text.getBBox();
        if (!bbox || !isFinite(bbox.width) || bbox.width === 0) return;
        svg.setAttribute('viewBox', [bbox.x, bbox.y, bbox.width, bbox.height].join(' '));
        svg.setAttribute('width', bbox.width);
        svg.setAttribute('height', bbox.height);
      } catch (e) {}
    }
    function setStartOffsets(svg, startPercent) {
      var paths = svg.querySelectorAll('textPath');
      if (!paths || paths.length === 0) return;
      var a = startPercent;
      var b = (startPercent + 33.3334) % 100;
      var c = (startPercent + 66.6667) % 100;
      if (paths[0]) paths[0].setAttribute('startOffset', a + '%');
      if (paths[1]) paths[1].setAttribute('startOffset', b + '%');
      if (paths[2]) paths[2].setAttribute('startOffset', c + '%');
    }
    function optimizeStartOffset(svg) {
      if (!svg) return;
      var text = svg.querySelector('text');
      if (!text) return;
      var best = { p: 0, diff: Infinity, bbox: null };
      for (var p = 0; p < 100; p += 1) {
        setStartOffsets(svg, p);
        var bb = text.getBBox();
        if (!bb || !isFinite(bb.width) || !isFinite(bb.height)) continue;
        var d = Math.abs(bb.width - bb.height);
        if (d < best.diff) {
          best = { p: p, diff: d, bbox: bb };
        }
      }
      setStartOffsets(svg, best.p);
      return best.bbox;
    }
    function init() {
      var svg = document.currentScript && document.currentScript.previousElementSibling;
      if (!(svg && svg.classList && svg.classList.contains('textcircle'))) {
        svg = document.querySelector('.circle-container .textcircle');
      }
      // Try to find the startOffset that makes bbox as square as possible
      var bbox = optimizeStartOffset(svg);
      // Then size the SVG to the computed bbox
      if (!bbox) {
        resizeTextCircle(svg);
      } else {
        svg.setAttribute('viewBox', [bbox.x, bbox.y, bbox.width, bbox.height].join(' '));
        svg.setAttribute('width', bbox.width);
        svg.setAttribute('height', bbox.height);
      }
      window.addEventListener('resize', function() { resizeTextCircle(svg); });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
</div>

{% stylesheet %}
  .lookbook-group:has(> .shopify-block > .circle-container) {
    container-type: inline-size;
    container-name: circle-container;
  }

  .circle-container {
    position: relative;
    width: fit-content;
    height: auto;
    aspect-ratio: 1/1;
    padding: 4px;
    border: 1px solid var(--circle-color);
    border-radius: 50%;
    cursor: pointer;
  }

  .circle-container .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 0;
    height: 0;
    border-left: 35px solid var(--circle-color);
    border-top: 20px solid transparent;
    border-bottom: 20px solid transparent;
    z-index: 2;
  }

  @container circle-container (width > 250px) {
    .circle-container .play-icon {
      border-left: 40px solid var(--circle-color);
      border-top: 25px solid transparent;
      border-bottom: 25px solid transparent;
    }
  }

  @container circle-container (width < 150px) {
    .circle-container .play-icon {
      border-left: 17px solid var(--circle-color);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
    }
  }

  .circle-container svg {
    width: auto;
    height: auto;
    overflow: visible;
    transform: rotate(0deg);
    animation: spin 10s linear infinite;
    animation-play-state: running;
  }

  .circle-container.stop-on-hover:hover svg {
    animation-play-state: paused;

  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .circle-container text {
    font-size: var(--font-size--md);
    letter-spacing: 0.3rem;
    text-transform: uppercase;
    color: var(--text-color);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.lookbook_circle_text",
  "blocks": [],
  "settings": [
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "t:settings.text_color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "circle_color",
      "label": "t:settings.circle_color",
      "default": "#000000"
    },
    {
      "type": "checkbox",
      "id": "stop_on_hover",
      "label": "t:settings.stop_on_hover",
      "default": true
    },
    {
      "type": "text",
      "id": "text_1",
      "label": "t:settings.text_1",
      "default": "Text Content 1",
      "info": "t:info.maximum_characters"
    },
    {
      "type": "text",
      "id": "text_2",
      "label": "t:settings.text_2",
      "default": "Text Content 2",
      "info": "t:info.maximum_characters"
    },
    {
      "type": "text",
      "id": "text_3",
      "label": "t:settings.text_3",
      "default": "Text Content 3",
      "info": "t:info.maximum_characters"
    }
  ],
  "presets": [
    {
      "name": "t:names.lookbook_circle_text"
    }
  ]
}
{% endschema %}