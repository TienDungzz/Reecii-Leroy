{% comment %}
  Renders a megamenu for the header.

  Usage:
  {% render 'header-mega-menu' %}
{% endcomment %}

<div>
  <div
    id="Details-HeaderMenu-{{ forloopIndex }}"
    class="details--dropdown mega-menu mega-menu-style-2"
    {{ block.shopify_attributes }}
  >
    <div
      id="HeaderMenu-{{ link.handle }}"
      class="
        list-menu__item menu__link--level-1 header__menu-item list-menu__item link focus-inset link--hover-underline
        {% render 'highlight-class', order: '1', keys: keys, compare: link.title, settings: sec_settings %}
      "
      {%- if link.links != blank -%}
        aria-controls="submenu-{{ forloop.index }}"
        aria-haspopup="true"
        aria-expanded="false"
      {%- endif -%}
      style="{%  render 'highlight-style', order: '1', keys: keys, compare: link.title, settings: sec_settings %}"
    >
      {% if is_vertical_menu %}
        {% liquid
          assign width = 20

          assign ratio = 1

          assign image_style = 'width: ' | append: width | append: 'px;' | append: ';' | append: '--media-adapt-ratio:' | append: ratio | append: ';'

          assign image_sources = 'jpg,png,webp,avif' | split: ','
          assign found_image = false
        -%}

        {% for ext in image_sources %}
          {% assign ext = ext | strip %}
          {% assign item_image = link.handle | downcase | replace: ' ', '-' | append: '.' | append: ext %}
          {% if images[item_image] != blank and found_image == false %}
            {% assign found_image = true %}
            {% assign image = item_image | file_url %}
            <span class="icon-image" style="{{ image_style }}">
              <img
                src="{{ image }}"
                srcset="{{ image }} 450w, {{ image }} 900w"
                width="450"
                height="450"
                sizes="{{ sizes }}"
                loading="lazy"
                alt="{{ shop.name | escape }}"
              >
            </span>
          {% endif %}
        {% endfor %}
      {% endif %}
      <a
        class="text{% if link.child_active %} header__active-menu-item{% endif %}"
        {% if link.url != blank %}
          href="{{ link.url }}"
        {% else %}
          role="link" aria-disabled="true"
        {% endif %}
      >
        {{- link.title | escape -}}
      </a>
      {% if icon_type == 'caret' %}
        <span class="svg-wrapper">
          {{- 'icon-caret.svg' | inline_asset_content -}}
        </span>
      {% endif %}
      {% render 'highlight-label-menu', order: '1', keys: keys, compare: link.title, settings: sec_settings %}
    </div>
    <div
      id="MegaMenu-Content-{{ forloopIndex }}"
      class="list-menu--wrapper mega-menu__content z-1 motion-reduce global-settings-popup"
      tabindex="-1"
      style="--columns-count: {{ block.settings.grid }}; --gap-x: 1.6rem; --gap-y: 1.6rem"
    >
      <div class="mega-menu__container">
        <div class="page-width page-width--{{ block.settings.width }}">
          <ul
            class="mega-menu__list header__mega-submenu{% if link.levels == 1 %} mega-menu__list--condensed{% endif %}"
            role="list"
          >
            {%- for childlink in link.links -%}
              <li>
                <a
                  id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}"
                  href="{{ childlink.url }}"
                  class="
                    header__menu-item mega-menu__link mega-menu__link--level-2 link
                    {% if childlink.current %} list-menu__item--active{% endif %}
                    {% render 'highlight-class', order: '2', keys: keys, compare: childlink.title, settings: sec_settings %}
                  "
                  {% if childlink.current %}
                    aria-current="page"
                  {% endif %}
                  style="{%  render 'highlight-style', order: '2', keys: keys, compare: childlink.title, color: highlight_color, settings: sec_settings %}"
                >
                  <span class="text">
                    {{ childlink.title | escape }}
                  </span>
                  {% render 'highlight-label-menu',
                    order: '2',
                    keys: keys,
                    compare: childlink.title,
                    settings: sec_settings
                  %}
                </a>
                {%- if childlink.links != blank -%}
                  <ul class="list-unstyled" role="list">
                    {%- for grandchildlink in childlink.links -%}
                      <li>
                        <a
                          id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                          href="{{ grandchildlink.url }}"
                          class="
                            header__menu-item mega-menu__link link link--hover-underline
                            {% if grandchildlink.current %} list-menu__item--active{% endif %}
                            {% render 'highlight-class', order: '3', keys: keys, compare: grandchildlink.title, settings: sec_settings %}
                          "
                          {% if grandchildlink.current %}
                            aria-current="page"
                          {% endif %}
                          style="{%  render 'highlight-style', order: '3', key: 'highlighted_item_', compare: grandchildlink.title, color: highlight_color, settings: sec_settings %}"
                        >
                          <span class="text">
                            {{ grandchildlink.title | escape }}
                          </span>
                          {% render 'highlight-label-menu',
                            order: '3',
                            keys: keys,
                            compare: grandchildlink.title,
                            settings: sec_settings
                          %}
                        </a>
                      </li>
                    {%- endfor -%}
                  </ul>
                {%- endif -%}
              </li>
            {%- endfor -%}
          </ul>
        </div>
        {%- liquid
          assign has_mega_menu_images = false
          if block.settings.show_promotion_banner
            if block.settings.image_1 != blank or block.settings.image_2 != blank
              assign has_mega_menu_images = true
              assign mega_menu_images_size = 0
              assign image_index = 0
            endif
          endif
        -%}
        {%- for i in (1..2) -%}
          {%- capture capture_image -%}image_{{ i }}{%- endcapture -%}
          {%- liquid
            assign image = block.settings[capture_image]
            if image != blank
              assign mega_menu_images_size = mega_menu_images_size | plus: 1
            endif
          -%}
        {%- endfor -%}
        <div class="mega-menu__collage-wrapper{% if block.settings.inherit_color_scheme == false %} color-{{ block.settings.color_scheme }}{% endif %}">
          <div class="page-width page-width--{{ block.settings.width }}">
            <div
              class="mega-menu__collage collage collage-3-columns collage--{{ block.settings.promotion_banner_layout }} collage--{{ mega_menu_images_size }}-items grid"
              style="
                --border-radius: {{ block.settings.image_corner_radius | divided_by: 10.0 }}rem;
                --border-width: {{ block.settings.image_border_thickness | divided_by: 10.0 }}rem;
                --gap-x: 1rem;
                --gap-y: 1rem;
              "
            >
              {%- if has_mega_menu_images == true -%}
                {%- for i in (1..2) -%}
                  {%- capture capture_image -%}image_{{ i }}{%- endcapture -%}
                  {%- capture capture_link_url -%}link_url_{{ i }}{%- endcapture -%}
                  {%- liquid
                    assign image = block.settings[capture_image]
                    assign link_url = block.settings[capture_link_url]
                  -%}
                  {%- if image != blank -%}
                    {%- assign image_index = image_index | plus: 1 -%}
                    <div
                      class="
                        overflow-hidden
                        collage__item
                        collage__item--image
                        collage__item--{{ image_index }}
                      "
                    >
                      <a
                        class="block"
                        {% if link_url != blank %}
                          href="{{ link_url }}"
                        {% else %}
                          role="link" aria-disabled="true"
                        {% endif %}
                      >
                        {%- liquid
                          assign ratio = image.aspect_ratio | default: 1
                          assign image_alt = image.alt | default: shop.name | escape
                        -%}
                        <div
                          class="media media--transparent media--adapt"
                          style="--media-adapt-ratio: {{ ratio }};"
                        >
                          {{
                            image
                            | image_url: width: 600
                            | image_tag:
                              loading: 'lazy',
                              widths: '275, 550, 710',
                              sizes: sizes,
                              alt: image_alt,
                              class: 'motion-reduce'
                          }}
                        </div>
                      </a>
                    </div>
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
              {% if block.settings.show_brand %}
                <div
                  class="
                    menu-dropdown__block menu-dropdown__brand collage__item collage__item--3
                  "
                >
                  {% if block.settings.brand_title %}
                    <h3 class="menu-dropdown__block--title h6">
                      <span>{{ block.settings.brand_title | escape }}</span>
                    </h3>
                  {% endif %}
                  <div class="menu-dropdown__block--content">
                    <ul class="azbrandsTable list-unstyled">
                      {% assign brand_letters = '' %}
                      {% assign alphabet = 'A|B|C|D|E|F|G|H|I|J|K|L|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z|1-9' | split: '|' %}
                      {% for vendor in shop.vendors %}
                        {% assign first = vendor | strip_html | slice: 0, 1 | upcase %}
                        {% unless brand_letters contains first %}
                          {% assign brand_letters = brand_letters | append: first %}
                        {% endunless %}
                      {% endfor %}
                      {% for letter in alphabet %}
                        <li>
                          <a
                            href="{{ block.settings.brand_url | default: '' }}#{{ letter | downcase }}"
                            class="link link--underline{% if brand_letters contains letter %} is-active{% endif %}"
                          >
                            <span>{{ letter }}</span>
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% if block.settings.brand_text %}
                    <div style="--mt: var(--margin-md);">
                      <a
                        {% if block.settings.brand_url == blank %}
                          role="link" aria-disabled="true"
                        {% else %}
                          href="{{ block.settings.brand_url }}"
                        {% endif %}
                        class="link link--underline"
                      >
                        <span>{{ block.settings.brand_text | escape }}</span>
                      </a>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
