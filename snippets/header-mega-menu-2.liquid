{% comment %}
  Renders a megamenu for the header.

  Usage:
  {% render 'header-mega-menu' %}
{% endcomment %}

{%- liquid
  assign bl_stts = block.settings
  assign divider = bl_stts.divider

  assign section_fetch = false
  if section.index == null
    assign section_fetch = true
  endif
-%}

{%- unless section_fetch -%}
  <div
    id="MegaMenu-Content-{{ section.id }}-{{ forloopIndex }}-{{ block_id }}"
    class="list-menu--wrapper"
    tabindex="-1"
    style="--columns-count: {{ bl_stts.grid }}; --gap-x: 1.6rem; --gap-y: 1.6rem"
  ></div>
{%- else -%}
  <div
    id="MegaMenu-Content-{{ section.id }}-{{ forloopIndex }}-{{ block_id }}"
    class="list-menu--wrapper mega-menu--2"
    tabindex="-1"
    style="--columns-count: {{ bl_stts.grid }}; --gap-x: 1.6rem; --gap-y: 1.6rem"
  >
    <div class="mega-menu__container page-width page-width--{{ bl_stts.width }} flex items-stretch justify-between flex-nowrap" style="--gap-x: 5.6rem">
      <ul
        class="mega-menu__list header__mega-submenu flex flex-column{% if link.levels == 1 %} mega-menu__list--condensed{% endif %}"
        role="list"
        style="--gap-y: 4rem"
      >
        {%- for childlink in link.links -%}
          <li>
            <a
              id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}"
              href="{{ childlink.url }}"
              class="
                header__menu-item mega-menu__link mega-menu__link--level-2 link flex
                {% if childlink.current %} list-menu__item--active{% endif %}
                {% render 'highlight-class', order: '2', keys: keys, compare: childlink.title, settings: sec_settings %}
              "
              {% if childlink.current %}
                aria-current="page"
              {% endif %}
              style="{%  render 'highlight-style', order: '2', keys: keys, compare: childlink.title, color: highlight_color, settings: sec_settings %}"
            >
              {{ childlink.title | escape }}
              {% render 'highlight-label-menu',
                order: '2',
                keys: keys,
                compare: childlink.title,
                settings: sec_settings
              %}
            </a>
            {%- if childlink.links != blank -%}
              <ul class="list-unstyled" role="list">
                {%- for grandchildlink in childlink.links -%}
                  <li>
                    <a
                      id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                      href="{{ grandchildlink.url }}"
                      class="
                        header__menu-item mega-menu__link link mega-menu__link--level-3 flex
                        {% if grandchildlink.current %} list-menu__item--active{% endif %}
                        {% render 'highlight-class', order: '3', keys: keys, compare: grandchildlink.title, settings: sec_settings %}
                      "
                      {% if grandchildlink.current %}
                        aria-current="page"
                      {% endif %}
                      style="{%  render 'highlight-style', order: '3', keys: keys, compare: grandchildlink.title, color: highlight_color, settings: sec_settings %}"
                    >
                      {{ grandchildlink.title | escape }}
                      {{- 'icon-arrow.svg' | inline_asset_content -}}
                      {% render 'highlight-label-menu',
                        order: '3',
                        keys: keys,
                        compare: grandchildlink.title,
                        settings: sec_settings
                      %}
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
      {%- liquid
        assign has_mega_menu_images = false
        if bl_stts.show_promotion_banner
          if bl_stts.image_1 != blank or bl_stts.image_2 != blank
            assign has_mega_menu_images = true
            assign mega_menu_images_size = 0
            assign image_index = 0
          endif
        endif
      -%}
      {%- for i in (1..3) -%}
        {%- capture capture_image -%}image_{{ i }}{%- endcapture -%}
        {%- liquid
          assign image = bl_stts[capture_image]
          if image != blank
            assign mega_menu_images_size = mega_menu_images_size | plus: 1
          endif
        -%}
      {%- endfor -%}
      {%- if has_mega_menu_images == true -%}
          <div
            class="mega-menu__collage collage collage-2-columns collage--{{ mega_menu_images_size }}-items grid h-full"
            style="
              --border-radius: {{ bl_stts.image_corner_radius | divided_by: 10.0 }}rem;
              --border-width: {{ bl_stts.image_border_thickness | divided_by: 10.0 }}rem;
              --gap-x: 1.2rem;
              --gap-y: 1.2rem;
            "
          >
            {%- for i in (1..3) -%}
              {%- capture capture_image -%}image_{{ i }}{%- endcapture -%}
              {%- liquid
                assign image = bl_stts[capture_image]
                assign link_url = link.links[image_index].url
                assign link_title = link.links[image_index].title
              -%}
              {%- if image != blank -%}
                {%- assign image_index = image_index | plus: 1 -%}
                <div
                  class="
                    overflow-hidden
                    collage__item
                    collage__item--image
                    collage__item--{{ image_index }}
                  "
                >
                  <a
                    class="block relative"
                    {% if link_url != blank %}
                      href="{{ link_url }}"
                    {% else %}
                      role="link" aria-disabled="true"
                    {% endif %}
                  >
                    {%- liquid
                      assign ratio = image.aspect_ratio | default: 1
                      assign image_alt = image.alt | default: shop.name | escape
                      assign widths = '275, 550, 710'
                      assign sizes = 'auto, (min-width: 750px) 50vw, 100vw'
                      assign class = 'motion-reduce'
                    -%}
                    <div
                      class="media media--transparent media--adapt"
                      style="--media-adapt-ratio: {{ ratio }};"
                    >
                      {%- render 'image',
                        image: image,
                        sizes: sizes,
                        widths: widths,
                        loading: 'lazy',
                        alt: image_alt,
                        class: class
                      -%}
                    </div>
                    <div class="overlay-text absolute bottom-0" style="--p: 1.6rem; --w: 100%">
                      <span class="text">{{- link_title -}}</span>
                    </div>
                  </a>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
      {%- endif -%}
      {%- if bl_stts.megamenu_submenu != blank -%}
      <div class="mega-menu__right right flex flex-column justify-between">
        {%- if bl_stts.megamenu_submenu != blank -%}
        <div class="mega-menu__submenu" role="list">
          <ul class="list-unstyled flex flex-column" role="list" style="--gap: 1.6rem">
            {% for link in bl_stts.megamenu_submenu.links %}
              <li>
                <a
                  href="{{ link.url }}"
                  title="{{ link.title | escape }}"
                  class="
                    header__menu-item mega-menu__link mega-menu__link--level-2 link
                    {% render 'highlight-class', order: '2', keys: keys, compare: link.title, settings: sec_settings %}
                  "
                  style="{%  render 'highlight-style', order: '2', keys: keys, compare: link.title, color: highlight_color, settings: sec_settings %}"
                >
                  {{ link.title | escape }}
                  {% render 'highlight-label-menu',
                    order: '2',
                    keys: keys,
                    compare: link.title,
                    settings: sec_settings
                  %}
                </a>
              </li>
              {%- if forloop.first -%}
                <li>
                  <div class="divider spacing-style">
                    <span class="divider__line" style="--divider-border-thickness: 1px;--divider-flex-basis: 100%;"></span>
                  </div>
                </li>
              {%- endif -%}
            {% endfor %}
          </ul>
        </div>
        {%- endif -%}
        {%- if bl_stts.show_social -%}
        <div class="mega-menu__right-bottom flex flex-column justify-between" style="--gap: 5.6rem">
          <div class="mega-menu__social flex flex-column" style="--gap: 1.2rem">
            <span class="social-title">{{ 'content.social_media_title' | t }}</span>
            {%- render 'social-icons' -%}
          </div>
          {%- if bl_stts.show_copyright -%}
            <span class="copyright-title">{{ 'content.copyright_title' | t }}</span>
          {%- endif -%}
        </div>
        {%- endif -%}
      </div>
      {% endif %}
    </div>
  </div>
{%- endunless -%}
